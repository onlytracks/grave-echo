{
  "id": "a4b2f334",
  "title": "AI potion use — harder enemies drink healing potions when low HP",
  "tags": [
    "gameplay",
    "ai",
    "items",
    "combat"
  ],
  "status": "open",
  "created_at": "2026-02-15T22:42:19.042Z"
}

## Goal
Harder enemies (guardians, bosses) should drink healing potions when low on HP.
Weaker enemies carry potions but never use them — they're loot piñatas. This adds
tactical depth: rush the guardian before it heals, or accept a longer fight knowing
you still get a full potion on kill.

**Key rule**: enemy potion use does NOT consume charges. The dropped potion always
has full charges. The AI "drinking" is a combat ability, not real consumable state.
This avoids punishing the player for not killing fast enough.

## Which Enemies Drink

| Pattern | Can Drink | Rationale |
|---------|-----------|-----------|
| Charger (goblin) | no | Mindless rush, no tactics |
| Archer | no | Already annoying at range |
| Skulker | no | Hit-and-run, not sustain |
| Patrol | no | Sentry, not combat specialist |
| Guardian | **yes** | Tanky, meant to be a wall |
| Boss | **yes** | Should feel dangerous and smart |

Controlled by a flag on AIControlled or checked by pattern in the AI system.

## Mechanics

### When to Drink
- Entity is **alert** (in combat)
- HP is at or below **40%** of max
- Entity has a **Consumable** item in inventory with `effectType === "heal"`
- Entity has **not already used primary action** this turn
- Drinking is a **primary action** (ends their turn — same as player rules)

### Healing Amount
Apply the potion's `power` value to the entity's HP, capped at max. This uses
the same heal logic as the player path, but does NOT decrement charges.

### One Drink Per Fight
To prevent the AI from healing every turn while tanking:
- Track whether the entity has used a potion this combat encounter
- Simple approach: add `hasUsedPotion: boolean` to AIControlled, reset when
  entity returns to idle
- This means guardians/bosses get ONE heal per alert phase. If the player
  retreats and re-engages, the enemy can drink again (fair — the player
  had a chance to restock too)

### Priority in AI Turn
Drinking happens BEFORE movement and attack. Check at the start of the
behavior function:

```typescript
function shouldDrinkPotion(world: World, entity: Entity): boolean {
  const ai = world.getComponent(entity, "AIControlled")!;
  if (ai.hasUsedPotion) return false;
  
  const health = world.getComponent(entity, "Health")!;
  if (health.current / health.max > 0.4) return false;
  
  const inventory = world.getComponent(entity, "Inventory");
  if (!inventory) return false;
  
  return inventory.items.some(id => {
    const c = world.getComponent(id, "Consumable");
    return c?.effectType === "heal";
  });
}

function drinkPotion(world: World, entity: Entity, messages: MessageLog): void {
  const health = world.getComponent(entity, "Health")!;
  const inventory = world.getComponent(entity, "Inventory")!;
  const ai = world.getComponent(entity, "AIControlled")!;
  
  const potionId = inventory.items.find(id => {
    const c = world.getComponent(id, "Consumable");
    return c?.effectType === "heal";
  });
  if (!potionId) return;
  
  const consumable = world.getComponent(potionId, "Consumable")!;
  const healed = Math.min(consumable.power, health.max - health.current);
  health.current += healed;
  ai.hasUsedPotion = true;
  
  // DO NOT decrement charges — potion drops with full charges
  
  const name = entityName(world, entity);
  messages.add(`${getDisplayName(world, entity)} drinks a potion! (+${healed} HP)`);
  messages.add(`[ai] ${name}: drank potion, healed ${healed}, hp=${health.current}/${health.max}`, "debug");
  
  const turnActor = world.getComponent(entity, "TurnActor")!;
  turnActor.hasActed = true;
  turnActor.movementRemaining = 0;
}
```

### Integration in Behavior Functions
At the top of `guardianBehavior()` and boss behavior (currently charger for boss):

```typescript
if (shouldDrinkPotion(world, entity)) {
  drinkPotion(world, entity, messages);
  return;  // primary action used, turn over
}
```

## AIControlled Component Change
Add optional field:

```typescript
export interface AIControlled {
  pattern: "charger" | "archer" | "guardian" | "skulker" | "patrol";
  targetEntity: number | null;
  patrolPath?: { x: number; y: number }[];
  patrolIndex?: number;
  hasUsedPotion?: boolean;  // new — reset on return to idle
}
```

Reset in `updateAwareness()` when transitioning from alert → idle:

```typescript
if (awareness.state === "idle") {
  ai.hasUsedPotion = false;
}
```

## Player Feedback
- Gameplay message: "The Ћ drinks a potion! (+8 HP)" — player sees the heal amount
- Debug message: full details (entity name, hp before/after)
- This is telegraphed: the enemy used its turn to drink instead of attacking. The
  player gets a free turn of movement/positioning.

## Depends On
- **TODO-f33eccc0** (enemies carry potions) — must be done first so enemies have
  potions to drink

## Files to Change
- `src/ecs/components.ts` — add `hasUsedPotion?: boolean` to AIControlled
- `src/ecs/systems/ai.ts` — add `shouldDrinkPotion()`, `drinkPotion()`, integrate
  into guardian + boss behavior
- `src/ecs/systems/sensory.ts` — reset `hasUsedPotion` on alert→idle transition
- `src/ecs/systems/entity-name.ts` — may need `getDisplayName` export (or inline)

## Tests
- Unit: guardian at 40% HP with potion drinks it
- Unit: guardian at 50% HP with potion does NOT drink
- Unit: charger at 20% HP with potion does NOT drink (wrong pattern)
- Unit: drinking heals correct amount, caps at max HP
- Unit: drinking does NOT decrement potion charges
- Unit: drinking sets hasActed=true (ends turn)
- Unit: hasUsedPotion prevents second drink in same alert phase
- Unit: hasUsedPotion resets when entity returns to idle
- Manual: guardian drinks potion mid-fight, message appears
- Manual: kill guardian after it drinks, potion drops with full charges
- `bun test` passes

## Definition of Done
- Guardians and bosses drink healing potions at ≤40% HP
- Other enemy types never drink (carry only for drops)
- Drinking is a primary action (ends turn)
- One drink per alert phase
- Potion charges NOT consumed — drops with full charges
- Clear gameplay message when enemy drinks
- `bun test` passes
