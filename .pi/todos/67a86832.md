{
  "id": "67a86832",
  "title": "Phase 2.5a: Basic death + restart loop",
  "tags": [
    "phase-2",
    "gameplay",
    "death"
  ],
  "status": "done",
  "created_at": "2026-02-15T05:06:31.722Z"
}

## Goal
When the player dies, show a game over screen and let them restart with a freshly
generated dungeon. Currently death shows "You died. Press any key to quit." and exits
the process. This makes the game a single-attempt experience. The restart loop is the
minimum viable roguelite — die, see what happened, try again.

## Read First
- `AGENTS.md` — project constraints
- `docs/core-loop.md` — death, run structure (for future context, not implemented here)

## Existing Code Context

### Death Handling (`src/game.ts`)
```typescript
if (healthResult.playerDied) {
  this.state = GameState.Dead;
  break;
}
// ...
if (this.state === GameState.Dead) {
  this.render();
  // draws "You died. Press any key to quit."
  await waitForInput();
}
// run() returns, main() shuts down renderer and exits
```

### Game Initialization (`src/index.ts`)
`main()` creates World, generates dungeon, spawns entities, creates Game, calls
`game.run()`. All one-shot — no restart path.

### GameState Enum (`src/game.ts`)
```typescript
enum GameState { Running, Dead }
```

## Requirements

### 1. Game Over Screen
Replace the single-line death message with a proper game over display. Render in the
messageLog region (bottom-left panel area):

```
╔══════════════════════════════╗
║        YOU HAVE DIED         ║
║                              ║
║   Turns survived: 23         ║
║   Enemies slain:  7          ║
║                              ║
║   [Enter] Try Again          ║
║   [Q]     Quit               ║
╠══════════════════════════════╝
```

Stats to show:
- Turns survived (from `turnCounter`)
- Enemies slain (need to track this — add a kill counter)

Keep it simple. This is a placeholder for a richer death screen later.

### 2. Kill Counter
Add a simple kill counter to the Game class. Increment when `processHealth` destroys
a non-player entity that has `AIControlled`:

```typescript
// In Game class
private killCount: number = 0;
```

Either track in Game by checking health results, or have `processHealth` return the
count of AI entities killed this tick.

### 3. Restart Flow
When the player presses Enter on the game over screen:

1. Create a new `World`
2. Generate a new dungeon (`generateDungeon()`)
3. Spawn fresh entities (player, enemies, items)
4. Reset game state (`GameState.Running`, `turnCounter = 0`, `killCount = 0`)
5. Compute initial FOV
6. Resume the game loop

This can be implemented as:
- A `restart()` method on Game that resets everything
- Or restructuring `run()` to loop: `while not quit: play round → game over → restart`

The simpler approach: wrap the game loop in an outer loop.

```typescript
async run(): Promise<void> {
  while (true) {
    this.initNewRun();
    await this.playUntilDeath();
    const choice = await this.showGameOver();
    if (choice === "quit") break;
  }
}
```

### 4. Extract Entity Spawning
Entity creation is currently in `src/index.ts`. For restart to work, it needs to be
callable again with a fresh world and dungeon. Options:

- Move spawning into a `initRun(world, rooms)` function exported from `index.ts`
  or a new `src/run-setup.ts`
- Game.restart() calls it

This overlaps with Phase 2.2b (room populator). If 2.2b is done first, the populator
handles this. If not, extract the current hardcoded spawning into a reusable function.

### 5. Clean World Reset
When restarting, the old World must be fully discarded. Don't try to clear entities
individually — create a fresh `new World()`. This avoids stale entity/component
references.

### 6. GameState Update
Add a `GameOver` state distinct from `Dead` if needed, or reuse `Dead` for the
game over screen. Add handling for the restart input.

```typescript
enum GameState { Running, Dead, Quit }
```

### 7. Quit Option
Pressing Q on the game over screen exits the game (current behavior). Pressing Enter
restarts. ESC also quits.

## Tests
- Manual: dying shows game over screen with turn count and kill count
- Manual: pressing Enter restarts with a new dungeon layout
- Manual: new run has full HP, no inventory, fresh enemies
- Manual: pressing Q on game over exits cleanly
- Manual: multiple death/restart cycles don't crash or leak
- `bun test` passes

## Definition of Done
- Game over screen shows run stats (turns, kills)
- Enter restarts with fresh world and dungeon
- Q quits cleanly
- Multiple restart cycles work without issues
- Kill counter tracks enemies defeated
- `bun test` passes
