{
  "id": "43f39c9e",
  "title": "Fix player alert feedback loop — alert should be based on enemy sensing player, not player seeing alert enemy",
  "tags": [
    "bug",
    "awareness",
    "sensory",
    "gameplay"
  ],
  "status": "open",
  "created_at": "2026-02-15T06:32:33.149Z"
}

## Problem
`updatePlayerAwareness()` in `src/ecs/systems/sensory.ts` makes the player alert
when they can **see** an alert enemy. This is wrong — it creates a feedback loop:

1. Enemy spots player at range 6, goes alert
2. Player retreats to range 8 — outside enemy vision (6) but inside player vision (8)
3. Enemy can't see player → starts `turnsWithoutTarget` decay
4. But player still sees the alert enemy → player stays alert → strict turn economy
5. Player is stuck: limited movement, can't easily close distance or escape, enemy
   is decaying but still visible and alert for several turns

The player becomes trapped in alert mode watching an enemy that can't reach them
and that they have no reason to feel threatened by.

## Root Cause
```typescript
// src/ecs/systems/sensory.ts — updatePlayerAwareness()
for (const entity of entities) {
  // ...
  if (entityAwareness.state !== "alert") continue;        // enemy is alert
  if (visible.has(`${entityPos.x},${entityPos.y}`)) {     // player can SEE it
    anyAlert = true;  // ← WRONG: player becomes alert
  }
}
```

The condition checks: "can the player see an alert enemy?"
It should check: "can an enemy see the player?"

## Fix
Change `updatePlayerAwareness` to check whether any enemy has LOS to the player
within that enemy's vision range:

```typescript
export function updatePlayerAwareness(
  world: World,
  map: GameMap,
  visible: Set<string>,  // still used for debug display
  messages?: MessageLog,
): void {
  const players = world.query("PlayerControlled", "Awareness", "Position");
  if (players.length === 0) return;

  const player = players[0]!;
  const playerPos = world.getComponent(player, "Position")!;
  const awareness = world.getComponent(player, "Awareness")!;
  const prevState = awareness.state;

  const enemies = world.query("Position", "Faction", "Senses");
  let anyThreat = false;
  let threatEntity: Entity | null = null;

  for (const entity of enemies) {
    if (entity === player) continue;
    const faction = world.getComponent(entity, "Faction")!;
    if (faction.factionId === "player" || faction.factionId === "neutral") continue;

    const entityPos = world.getComponent(entity, "Position")!;
    const entitySenses = world.getComponent(entity, "Senses")!;

    // Check if THIS ENEMY can sense the player (within its vision range + LOS)
    const dist = Math.abs(entityPos.x - playerPos.x) + Math.abs(entityPos.y - playerPos.y);
    if (dist > entitySenses.vision.range) continue;
    if (!hasLineOfSight(map, entityPos.x, entityPos.y, playerPos.x, playerPos.y)) continue;

    anyThreat = true;
    threatEntity = entity;
    break;
  }

  awareness.state = anyThreat ? "alert" : "idle";

  // ... existing debug messages ...
}
```

This means:
- Player is alert ONLY when an enemy can actually see them
- Walking out of enemy vision range → player immediately goes idle
- No more feedback loop from seeing decaying-alert enemies at distance

## Edge Case
The enemy `Awareness` component is no longer relevant to player alert. This is
correct — player alert is about whether they're IN DANGER, not about what they
observe. The enemy's awareness state still drives enemy AI behavior independently.

## Files to Change
- `src/ecs/systems/sensory.ts` — rewrite `updatePlayerAwareness()`

## Tests
- Unit test: player NOT alert when seeing alert enemy outside enemy's vision range
- Unit test: player IS alert when within enemy vision range + LOS
- Unit test: player goes idle immediately when stepping out of enemy vision
- Unit test: enemy with no LOS to player (wall) doesn't trigger player alert
- Manual: retreating from enemy stops alert mode once out of enemy's vision range
- `bun test` passes

## Definition of Done
- Player alert based on enemy-can-sense-player, not player-can-see-enemy
- No feedback loop at asymmetric vision ranges
- `bun test` passes

## Additional Fix: Gameplay Messages for Alert Transitions

Currently all awareness messages are `"debug"` category — invisible in the message log.
The player sees `[ALERT!]` in the stats panel but has no idea why.

Add gameplay messages alongside the debug ones in `updatePlayerAwareness()`:

**Idle → Alert:**
```
You sense danger nearby!
```
(gameplay category — visible in message log)

**Alert → Idle:**
```
The threat has passed.
```

Keep the existing debug messages too (with entity details, distance, etc.) for the
debug panel. The gameplay messages are vague on purpose — the player knows something
is wrong but has to look around to find the threat.

### Implementation
```typescript
if (awareness.state !== prevState) {
  if (awareness.state === "alert") {
    messages.add("You sense danger nearby!", "gameplay");
    messages.add(`[sense] Player alert: ${name} sensing at d=${dist}`, "debug");
  } else {
    messages.add("The threat has passed.", "gameplay");
    messages.add(`[sense] Player: alert → idle`, "debug");
  }
}
```
