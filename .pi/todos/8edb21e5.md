{
  "id": "8edb21e5",
  "title": "Weapon swap quick-select popup — 's' opens picker instead of blind cycling",
  "tags": [
    "gameplay",
    "ui",
    "items",
    "combat"
  ],
  "status": "open",
  "created_at": "2026-02-15T22:20:36.440Z",
  "assigned_to_session": "2ae8fb80-2835-4454-811d-706a8e9bd05e"
}

## Goal
Pressing `s` currently cycles to the next weapon in inventory with no preview.
Replace with a quick-select popup (same pattern as `u` for consumables): `s`
opens a popup listing all weapons in inventory with key stats, player picks one
by number, Escape cancels. Swapping is a **secondary action** — costs nothing
to open/cancel, but selecting a weapon consumes the secondary action.

## Current Behavior (blind cycle)
`swapToNextWeapon()` in `src/ecs/systems/inventory.ts` finds all weapons in
inventory, picks the next one after the current, and equips it. No preview,
no choice, no stat display. With 3+ weapons you have to cycle repeatedly to
find the one you want, burning secondary actions each time.

## New Behavior

### Quick-Select Popup
1. Player presses `s`
2. If secondary already used this turn → message "Already used secondary action."
3. If no other weapons in inventory → message "No other weapons."
4. If weapons exist → enter `GameState.SwapWeapon` state, render popup
5. Popup shows numbered list of weapons with key stats
6. Player presses number key (1-9) to equip that weapon, Escape to cancel
7. Selecting a weapon is a **secondary action** (sets `secondaryUsed = true`)
8. Canceling returns to `GameState.Running` with no cost

### Popup Display
```
┌─ Swap Weapon ──────────────────┐
│                                 │
│  1. Iron Sword        4dmg r1  │
│  2. Hunting Bow       3dmg r6  │
│  3. Oak Spear         5dmg r2  │
│                                 │
│  Currently: Iron Sword    [E]   │
│  [1-3] swap  [Esc] cancel      │
└─────────────────────────────────┘
```

Show: number, weapon name, damage, range. Mark currently equipped with `[E]`.
Selecting the already-equipped weapon does nothing (no secondary action cost).

### Size
- Width: fit to longest weapon name + stats + padding, min 28
- Height: weapon count + 5 (title, blank, items, current, footer)
- Capped to game grid region bounds
- Centered in game grid region

## Implementation

### 1. New GameState
Add `SwapWeapon` to the `GameState` enum in `src/game.ts`.

### 2. SwapWeapon Screen State
Create `src/ui/swap-weapon-screen.ts`:

```typescript
export interface SwapWeaponScreenState {
  weapons: Entity[];       // all weapons in inventory
  equippedWeapon: Entity | null;  // currently equipped weapon entity
}

export function createSwapWeaponScreenState(
  world: World,
  player: Entity,
): SwapWeaponScreenState | null {
  const inventory = world.getComponent(player, "Inventory");
  const equipment = world.getComponent(player, "Equipment");
  if (!inventory) return null;

  const weapons = inventory.items.filter(id =>
    world.hasComponent(id, "Weapon")
  );
  // Need at least 2 weapons (one equipped + one to swap to), or 1 if none equipped
  if (weapons.length === 0) return null;
  if (weapons.length === 1 && equipment?.weapon === weapons[0]) return null;

  return {
    weapons,
    equippedWeapon: equipment?.weapon ?? null,
  };
}

export function handleSwapWeaponKey(
  key: number,
  state: SwapWeaponScreenState,
): Entity | null | "cancel" {
  if (key === 0x1b) return "cancel";
  if (key >= 0x31 && key <= 0x39) {
    const index = key - 0x31;
    if (index < state.weapons.length) {
      const selected = state.weapons[index]!;
      // Selecting already-equipped weapon = cancel (no cost)
      if (selected === state.equippedWeapon) return "cancel";
      return selected;
    }
    return null;
  }
  return null;
}

export function renderSwapWeaponScreen(
  renderer: Renderer,
  world: World,
  state: SwapWeaponScreenState,
  region: Region,
): void {
  // Black background fill (prevent bleed-through)
  // Draw box with "Swap Weapon" title
  // List weapons: number, name, damage, range, [E] if equipped
  // Show currently equipped weapon
  // Footer: [1-N] swap  [Esc] cancel
}
```

### 3. Game Integration
Same pattern as consumable popup and inventory screen:

- `private swapWeaponScreen: SwapWeaponScreenState | null = null;`
- `openSwapWeapon()`: check `secondaryUsed`, create state, set GameState
- `closeSwapWeapon()`: null state, set Running
- `handleSwapWeaponMode()`: wait for raw input, handle key
- On valid selection: equip weapon (set `equipment.weapon`), set `secondaryUsed = true`
- In `playUntilDeath()`: add `GameState.SwapWeapon` to while condition
- In `render()`: render popup when in SwapWeapon state

### 4. Intercept in Game Loop
Handle `swapWeapon` event in `game.ts` before `handlePlayerInput`, same as
`inventory` and `useItem`:

```typescript
if (event.type === "swapWeapon") {
  this.openSwapWeapon();
  continue;
}
```

### 5. Remove Blind Cycle from Input System
Remove the `swapWeapon` handler from `src/ecs/systems/input.ts` that calls
`swapToNextWeapon()`. The swap is now handled entirely by the popup in game.ts.

`swapToNextWeapon()` in `inventory.ts` can stay as a utility (AI might use it),
but the player path goes through the popup.

### 6. Background Fill (Critical)
Same as other popups — fill with black cells before drawing box:

```typescript
for (let y = boxY; y < boxY + boxH; y++) {
  for (let x = boxX; x < boxX + boxW; x++) {
    renderer.drawCell(x, y, " ", "white", "black");
  }
}
```

### 7. Stat Display
For each weapon, show compact stats:
- Name (from Item component)
- Damage (from Weapon.damage)
- Range (from Weapon.range) — helps player understand melee vs reach vs ranged
- Attack type indicator: `m` melee, `r` reach, `R` ranged (or just the range number)
- `[E]` tag if currently equipped

Color: equipped weapon in `brightYellow`, others in `white`.

## Edge Cases
- 0 weapons in inventory: message, no popup
- 1 weapon already equipped, no others: message "No other weapons.", no popup
- 1 weapon not equipped: popup shows it, selecting equips it
- Select already-equipped weapon: treat as cancel, no secondary action cost
- Secondary already used: message, no popup
- Weapon selected while unarmed (equipment.weapon === null): equip, cost secondary
- 10+ weapons: show first 9 (weight system makes this unrealistic)

## Files to Change
- `src/game.ts` — add SwapWeapon state, open/close/handle methods, render hook
- `src/ui/swap-weapon-screen.ts` — new file: state, render, input handling
- `src/ecs/systems/input.ts` — remove `swapWeapon` handler (player path only)
- `src/input/input-handler.ts` — `swapWeapon` event type stays as-is

## Tests
- Unit: createSwapWeaponScreenState returns null with no weapons
- Unit: createSwapWeaponScreenState returns null with only the equipped weapon
- Unit: createSwapWeaponScreenState lists all weapons, tracks equipped
- Unit: handleSwapWeaponKey returns correct entity for valid number
- Unit: handleSwapWeaponKey returns "cancel" for equipped weapon selection
- Unit: handleSwapWeaponKey returns "cancel" for Escape
- Manual: `s` opens popup, shows weapons with stats
- Manual: number key swaps weapon, costs secondary action
- Manual: Escape cancels without cost
- Manual: no UI bleed-through
- `bun test` passes

## Definition of Done
- `s` opens quick-select popup listing weapons with stats
- Number keys (1-9) select and equip a weapon
- Selecting already-equipped weapon cancels (no cost)
- Escape cancels without cost
- Swapping costs secondary action
- Popup has black background fill (no bleed-through)
- Blind cycle removed from player input path
- `bun test` passes

## Two-Weapon Fast Swap

When the entity has exactly 2 weapons in inventory (including the equipped one),
skip the popup and instantly swap to the other weapon. This preserves the current
quick-swap feel for the common case while only showing the popup when there are
3+ weapons and a real choice to make.

### Logic in `openSwapWeapon()`:

```typescript
private openSwapWeapon(): void {
  const player = this.getPlayerEntity();
  if (!player) return;
  const turnActor = this.world.getComponent(player, "TurnActor");
  if (turnActor?.secondaryUsed) {
    this.messages.add("Already used secondary action this turn.");
    return;
  }

  const state = createSwapWeaponScreenState(this.world, player);
  if (!state) {
    this.messages.add("No other weapons.");
    return;
  }

  // Fast swap: exactly 2 weapons, just toggle
  if (state.weapons.length === 2) {
    const other = state.weapons.find(id => id !== state.equippedWeapon)!;
    const equipment = this.world.getComponent(player, "Equipment")!;
    equipment.weapon = other;
    const item = this.world.getComponent(other, "Item");
    this.messages.add(`You swap to ${item?.name ?? "weapon"}`);
    if (turnActor) turnActor.secondaryUsed = true;
    return;
  }

  // 3+ weapons: show popup
  this.swapWeaponScreen = state;
  this.state = GameState.SwapWeapon;
}
```

### Thresholds
- **0 weapons**: "No other weapons." message
- **1 weapon already equipped**: "No other weapons." (createSwapWeaponScreenState returns null)
- **1 weapon not equipped**: instant equip, no popup
- **2 weapons**: instant swap to the other one, no popup
- **3+ weapons**: popup shown
