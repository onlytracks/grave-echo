{
  "id": "e3a16d4a",
  "title": "Phase 1.4: Vision System, Fog of War, AI Awareness",
  "tags": [
    "phase-1",
    "senses",
    "vision",
    "fow",
    "ai"
  ],
  "status": "done",
  "created_at": "2026-02-15T02:51:50.635Z"
}

## Goal
Implement a vision system with line-of-sight, fog of war for the player, and AI awareness
states so enemies only act when they can see the player. Currently enemies chase through
walls from across the dungeon — this fixes that.

## Read First
- `AGENTS.md` — project constraints, universal entity system
- `docs/senses.md` — full sensory system design, awareness states, fog of war, LOS algorithm
- `docs/combat.md` — AI Awareness section, AI behavior patterns
- `docs/technical.md` — turn flow with SensorySystem steps, Senses/Awareness components

## Existing Code Context

### Components (`src/ecs/components.ts`)
Current ComponentMap has: Position, Renderable, PlayerControlled, Collidable, Health, Stats,
TurnActor, AIControlled, Faction, Item, Weapon, Consumable, Inventory, Equipment.
New components (Senses, Awareness) must be added here.

### AI System (`src/ecs/systems/ai.ts`)
`processAI()` iterates all entities with AIControlled+TurnActor+Position+Stats and runs
their behavior pattern. Currently acts unconditionally — no awareness check.
The `chargerBehavior()` function chases `ai.targetEntity` using `tryMove()`.

### Game Loop (`src/game.ts`)
Turn flow: `startPlayerTurn` → player input loop → `processAI` → `processHealth` → next turn.
The sensory system needs to slot into this flow. `Game.render()` calls `renderGameGrid()`.

### Game Map (`src/map/game-map.ts`)
`GameMap` class with `getTile()`, `isInBounds()`. Tiles have a `transparent: boolean` field
(walls are `transparent: false`, floors are `transparent: true`). No visibility tracking yet.

### Renderer (`src/renderer/panels/game-grid.ts`)
`renderGameGrid()` draws all map tiles then all entities with Position+Renderable.
Currently renders everything — no visibility filtering.

### Debug Panel (`src/renderer/panels/debug-panel.ts`)
Shows entity details. Needs to be updated to show awareness state.

### Entry Point (`src/index.ts`)
Spawns player at room 1 center, goblins in rooms 2-5. Uses `generateDungeon()`.
New Senses/Awareness components must be added to entity creation.

## Requirements

### 1. New Components in `src/ecs/components.ts`

```typescript
Senses: {
  vision: { range: number };
}

Awareness: {
  state: 'idle' | 'alert';
  lastKnownTarget: { x: number; y: number } | null;
  alertDuration: number;
  turnsWithoutTarget: number;
}
```

Add both to the ComponentMap interface.

### 2. `src/ecs/systems/sensory.ts` — Sensory System

#### Line-of-Sight Function
```typescript
export function hasLineOfSight(
  map: GameMap, x0: number, y0: number, x1: number, y1: number
): boolean
```
Uses Bresenham's line algorithm. Returns true if no non-transparent tile blocks the ray
from (x0,y0) to (x1,y1). The starting tile is not checked (entity's own tile). The
destination tile IS checked for transparency only if it's an intermediate tile (the final
tile itself is always "reachable" if the ray gets there).

#### Compute Visible Tiles
```typescript
export function computeVisibleTiles(
  map: GameMap, originX: number, originY: number, range: number
): Set<string>  // Set of "x,y" strings
```
For every tile within `range` manhattan distance of origin, cast a ray using `hasLineOfSight`.
Return the set of all visible tile coordinates as `"x,y"` strings.

#### Update AI Awareness
```typescript
export function updateAwareness(
  world: World, map: GameMap, entity: Entity
): void
```
For an AI entity with Senses + Awareness + Position + Faction:
1. Compute visible tiles from entity's position using its vision range
2. Check if any hostile entity (check Faction) is on a visible tile
3. If hostile found:
   - Set `state = 'alert'`
   - Set `lastKnownTarget` to the hostile's position
   - Reset `turnsWithoutTarget = 0`
   - Set `AIControlled.targetEntity` to the detected hostile entity ID
4. If no hostile found:
   - Increment `turnsWithoutTarget`
   - If `turnsWithoutTarget > alertDuration`: set `state = 'idle'`, clear `lastKnownTarget`
   - (entity stays alert for `alertDuration` turns after losing sight)

#### Compute Player FOW
```typescript
export function computePlayerFOW(
  world: World, map: GameMap
): { visible: Set<string>; explored: Set<string> }
```
- Find the player entity (PlayerControlled + Position + Senses)
- Compute visible tiles
- Merge visible tiles into a persistent explored set
- Return both sets

The explored set needs to persist across turns. Store it on the GameMap (see below).

### 3. Update `src/map/game-map.ts` — Add Explored Tracking

Add to GameMap:
```typescript
private explored: boolean[][];

markExplored(x: number, y: number): void
isExplored(x: number, y: number): boolean
```

Initialize `explored` as all `false` in the constructor. The sensory system calls
`markExplored()` for each visible tile each turn.

### 4. Update `src/ecs/systems/ai.ts` — Gate AI on Awareness

In `processAI()`, before running the behavior pattern:
1. Call `updateAwareness(world, map, entity)` for each AI entity
2. Check `Awareness.state`:
   - `idle`: skip this entity entirely (no movement, no actions)
   - `alert`: run behavior pattern as normal

When alert but target is not currently visible (using `lastKnownTarget`):
- The charger should move toward `lastKnownTarget` instead of the live target position
- If the charger reaches `lastKnownTarget` and still can't see the target, it will
  eventually time out and return to idle

### 5. Update `src/renderer/panels/game-grid.ts` — Fog of War Rendering

Change `renderGameGrid()` to accept visibility data:
```typescript
export function renderGameGrid(
  renderer: Renderer,
  world: World,
  map: GameMap,
  region: { x: number; y: number; width: number; height: number },
  viewport: Viewport,
  visibleTiles: Set<string>,
): void
```

Rendering rules:
- **Visible tile** (in `visibleTiles` set): render normally (full color)
- **Explored tile** (not visible but `map.isExplored(x, y)`): render terrain in dark gray
  (`fg: 'gray'` for walls, dim floor). Do NOT render entities on explored tiles.
- **Hidden tile** (not visible, not explored): render nothing (black/empty)

For entities: only render entities whose position is in the `visibleTiles` set.

### 6. Update `src/game.ts` — Integrate Sensory System

In the game loop:
- After `startPlayerTurn()` and after each player movement: call `computePlayerFOW()`
- Store the current `visibleTiles` set on the Game instance
- Pass `visibleTiles` to `renderGameGrid()` in `render()`
- Before `processAI()`: awareness updates happen inside `processAI()` (see step 4)

Recalculate player FOW:
- At the start of each player turn
- After each player movement (so fog updates as you walk)

### 7. Update `src/index.ts` — Add Components to Entities

**Player:**
```typescript
world.addComponent(player, "Senses", { vision: { range: 8 } });
```

**Each goblin:**
```typescript
world.addComponent(goblin, "Senses", { vision: { range: 6 } });
world.addComponent(goblin, "Awareness", {
  state: 'idle',
  lastKnownTarget: null,
  alertDuration: 5,
  turnsWithoutTarget: 0,
});
```

### 8. Update Debug Panel

In `src/renderer/panels/debug-panel.ts`, for each AI entity show:
- Awareness state (`idle` / `alert`)
- `turnsWithoutTarget` when alert
- `lastKnownTarget` position when set

## Tests (`src/ecs/systems/__tests__/sensory.test.ts`)

### Line of Sight
- Clear line between two floor tiles returns true
- Wall blocking the path returns false
- Adjacent tiles always have LOS
- Same tile returns true
- Diagonal lines blocked by walls
- Edge of vision range is visible if unblocked

### Compute Visible Tiles
- Open room: all tiles within range are visible
- Wall blocks tiles behind it
- Vision doesn't extend beyond range
- Returns set of coordinate strings

### Awareness Updates
- Entity detects hostile in vision range → state becomes 'alert'
- Entity doesn't detect hostile out of range → stays 'idle'
- Entity loses sight of hostile → turnsWithoutTarget increments
- turnsWithoutTarget exceeds alertDuration → state becomes 'idle'
- Re-detecting hostile resets turnsWithoutTarget to 0
- Wall between entity and hostile → no detection (LOS blocked)

### Fog of War
- Visible tiles include explored marking on the map
- Player can't see around corners
- Previously explored tiles remain explored after moving away

### AI Gating
- Idle AI entity does not move or attack
- Alert AI entity behaves normally (chases, attacks)
- AI entity that loses sight continues toward lastKnownTarget
- AI entity at lastKnownTarget with no sight eventually goes idle

## Definition of Done
- Enemies stand idle until the player walks into their vision range
- Enemies that lose sight of the player pursue for `alertDuration` turns, then stop
- Player sees fog of war: unexplored areas are black, previously visited areas are dimmed
- Entities outside player's vision are not rendered
- Walking into a new room reveals it
- Debug panel shows awareness state for each enemy
- `bun test` passes all sensory system tests
- The sensory system is universal: same LOS algorithm for player FOW and enemy awareness
