{
  "id": "c3956c61",
  "title": "Rework target visibility — red floor dots for vision overlap, remove LOS line",
  "tags": [
    "quality-of-life",
    "ui",
    "renderer",
    "tactical"
  ],
  "status": "open",
  "created_at": "2026-02-15T13:52:55.773Z"
}

## Goal
Replace the current bright red LOS line (red background along Bresenham path) with
a subtler, more useful overlay: floor dots in the target's visible area turn red.
Only floors visible to BOTH the viewer and the target are painted — no revealing
hidden areas. This replaces the LOS line entirely.

The system is universal — works for any entity viewing any other entity's vision.

## Current Behavior (to remove)
In `renderGameGrid()`, when `targetEntity` is set:
1. Draws Bresenham LOS line from player to target with `darkGray` fg on `red` bg
2. Target entity gets `brightWhite` fg on `red` bg

The LOS line is noisy and doesn't convey tactical info. Remove it entirely.

## New Behavior
When any entity has a `TargetSelection` with a target that has `Senses` + `Position`:
1. Compute the target's visible tiles using `computeVisibleTiles()`
2. During the tile rendering loop, for floor tiles that are in BOTH the viewer's
   `visibleTiles` AND the target's vision: render the floor dot `·` in `red` fg
   instead of the normal `brightWhite` fg (visible) or `gray` fg (base tile)
3. Background stays `black` — no red background anywhere on floors
4. Target entity highlight: keep the `brightWhite` on `red` bg for the entity itself

### Visual
```
  ▓▓▓▓▓▓▓▓▓
  ▓·······▓     · = white dot (player can see, target cannot)
  ▓···g···▓     · = red dot (both player and target can see)
  ▓·······▓     g = enemy (brightWhite on red bg)
  ▓▓▓··▓▓▓     @ = player
     ·····
     ··@··      Red dots show the danger zone.
     ·····      White dots are blind spots.
```

The floor behind a wall stays white — the target can't see through it. Corners,
pillars, doorway edges all create clear safe/danger boundaries.

## Implementation

### 1. Compute Target Vision
Import `computeVisibleTiles` from `src/ecs/systems/sensory.ts` into `game-grid.ts`.

Before the tile loop:
```typescript
let targetVision: Set<string> | null = null;
if (targetEntity != null) {
  const targetPos = world.getComponent(targetEntity, "Position");
  const targetSenses = world.getComponent(targetEntity, "Senses");
  if (targetPos && targetSenses) {
    targetVision = computeVisibleTiles(
      map, targetPos.x, targetPos.y, targetSenses.vision.range
    );
  }
}
```

### 2. Modify Tile Rendering
In the visible tile branch of the tile loop:

```typescript
if (visibleTiles.has(key)) {
  const inTargetVision = targetVision?.has(key) ?? false;
  const fg = (tile.walkable && inTargetVision) ? "red" : tile.fg as Color;
  renderer.drawCell(innerX + dx, innerY + dy, tile.char, fg, tile.bg as Color);
}
```

Only walkable tiles (floors) get the red treatment. Walls keep their normal color —
they block vision, tinting them adds no info.

### 3. Remove LOS Line
Delete the entire `getLosTiles()` helper function and the block at the bottom of
`renderGameGrid()` that draws the LOS line (the `if (targetEntity !== null ...)`
block that calls `getLosTiles` and draws red-background tiles).

### 4. Keep Target Entity Highlight
The entity rendering loop already highlights the target entity with `brightWhite`
on `red` bg. Keep this — it marks which entity is selected.

### 5. Universal — Not Player-Specific
The function takes `visibleTiles` (the viewer's FOV) and `targetEntity`. It doesn't
reference `PlayerControlled` for the overlay. Any entity's FOV passed as
`visibleTiles` works.

The current code references `PlayerControlled` to find the LOS line origin —
that entire block is deleted.

## Supersedes
- **TODO-d2d266a7** (target vision red-tinted overlay) — that todo proposed `darkRed`
  background tint. This todo replaces it with the simpler red fg approach and also
  removes the LOS line. Close TODO-d2d266a7 as superseded when this is picked up.

## Files to Change
- `src/renderer/panels/game-grid.ts`:
  - Add import: `computeVisibleTiles` from `../../ecs/systems/sensory.ts`
  - Add target vision computation before tile loop
  - Modify visible tile rendering to use red fg for overlap floors
  - Delete `getLosTiles()` function
  - Delete LOS line rendering block at bottom
  - Keep target entity highlight in entity loop

## No New Colors Needed
Uses existing `"red"` from the Color type for floor dot fg.

## Performance
`computeVisibleTiles` for range 6-8 is ~100-200 raycasts — trivial. Computed once
per render frame, only when a target is selected.

## Edge Cases
- Target without `Senses` (e.g., an item): no overlay, floors stay normal
- Target at edge of player vision: only the overlap region shows red
- Player targeting themselves: their own vision shows as all-red (correct but useless)
- No target selected: no overlay computation, zero cost

## Definition of Done
- Floor dots turn red where both viewer and target can see
- Walls unchanged
- Bright red LOS line removed entirely
- `getLosTiles()` helper deleted
- Target entity still highlighted with red bg
- Works for any entity with Senses, not hardcoded to player
- TODO-d2d266a7 closed as superseded
- `bun test` passes
