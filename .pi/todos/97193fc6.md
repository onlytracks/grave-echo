{
  "id": "97193fc6",
  "title": "Phase 2.2a: Larger map + room variety",
  "tags": [
    "phase-2",
    "map",
    "worldgen"
  ],
  "status": "pending",
  "created_at": "2026-02-15T03:34:09.025Z"
}

## Goal
Increase the map size beyond the current 60×40 and introduce varied room shapes. The
viewport already scrolls and centers on the player, so larger maps work without any
rendering changes. This creates a sense of exploration and makes the dungeon feel less
cramped.

## Read First
- `AGENTS.md` — project constraints
- `docs/world.md` — region rhythm, pacing, room descriptions

## Existing Code Context

### Dungeon Generator (`src/map/dungeon-generator.ts`)
Current generator:
- Fixed 60×40 map
- 5 target rooms, rectangular only (5-10w × 5-8h)
- Rooms placed randomly with overlap check (1-tile gap)
- L-shaped corridors connecting sequential rooms (center-to-center)
- `assignWallCharacters()` post-pass for box-drawing walls
- Returns `{ map: GameMap, rooms: Room[] }`

### GameMap (`src/map/game-map.ts`)
- `GameMap(width, height, defaultTile)` — 2D tile array, explored tracking
- `Tile`: type, char, fg, bg, walkable, transparent
- `FLOOR_TILE` (·), `WALL_TILE` (#)

### Entity Spawning (`src/index.ts`)
- Player spawns at center of `rooms[0]`
- Items placed relative to room positions
- Goblins spawn at center of rooms 1-4
- All of this is hardcoded — will need to adapt to new room counts/sizes

### Viewport (`src/game.ts`)
- `calculateViewport()` centers on player, clamps to map bounds
- Already handles maps larger than the panel — no changes needed

## Requirements

### 1. Increase Map Size
Change `generateDungeon()` to accept config:

```typescript
interface DungeonConfig {
  width: number;      // default 120
  height: number;     // default 80
  roomCount: number;  // target rooms, default 8-12
  roomMinSize: number; // default 5
  roomMaxSize: number; // default 14
  rng: () => number;  // default Math.random
}
```

### 2. Room Shape Variety
Add room shape generators beyond rectangles. Each produces a set of floor tile
positions:

- **Rectangular** — current behavior (most common, ~50%)
- **L-shaped** — two overlapping rectangles forming an L
- **Circular/oval** — uses distance from center to carve a rough circle
- **Cross-shaped** — a + shape, good for larger encounter rooms

The `Room` interface needs updating to track both the bounding box (for overlap checks)
and the actual floor positions (for non-rectangular shapes):

```typescript
interface Room {
  x: number;
  y: number;
  width: number;
  height: number;
  floors: { x: number; y: number }[];  // actual walkable tiles
}
```

`carveRoom()` should iterate `floors` instead of the bounding box.
`roomCenter()` can average the floor positions or keep using bounding box center.

### 3. Room Size Variation
More variety in room dimensions:
- Small rooms (5×5 to 6×6) — tight corridors, ambush spots
- Medium rooms (7×7 to 10×8) — standard combat encounters
- Large rooms (11×9 to 14×12) — boss arenas, loot chambers

The generator should produce a mix: ~40% small, ~40% medium, ~20% large.

### 4. Corridor Improvements
Replace the simple L-shaped corridors with more variety:

- **L-corridor** — current behavior (keep, ~40%)
- **Winding corridor** — adds 1-2 random waypoints between rooms so the path isn't
  a straight L. Carve L-segments between each waypoint.
- **Wide corridor** — 2-3 tiles wide instead of 1, for main thoroughfares connecting
  important rooms

Corridors should carve through walls (current behavior), creating natural connections.

### 5. Dead-End Branches
After main room chain is connected, add 1-3 short dead-end corridors branching off
from random rooms. These create exploration incentive and future loot/secret placement.
A dead end is a corridor (4-8 tiles) leading to a small 3×3 or 4×4 room.

### 6. Update Entity Spawning
In `src/index.ts`, adapt spawning to work with variable room counts:
- Player still spawns in `rooms[0]`
- Distribute enemies across rooms (skip room 0)
- Place items in a subset of rooms
- Don't hardcode room indices — iterate rooms and assign based on count

### 7. Ensure Connectivity
After generation, verify all rooms are reachable. A simple flood-fill from `rooms[0]`
center should touch at least one floor tile in every room. If not, add a corridor to
connect isolated rooms.

## Tests
- `bun test` — existing tests still pass
- Manual: map feels larger, rooms visibly varied in shape
- Manual: scrolling works smoothly as player explores the larger map
- Manual: all rooms reachable (no isolated rooms)
- Manual: corridors connect rooms naturally, some winding paths exist
- Manual: dead-end branches exist and are explorable

## Definition of Done
- Map size configurable, default 120×80
- At least 3 room shapes (rectangular, L-shaped, circular)
- Room sizes vary (small/medium/large distribution)
- Corridors have variety (L, winding, wide)
- Dead-end branches exist
- All rooms verified reachable
- Entity spawning works with variable room counts
- `bun test` passes
