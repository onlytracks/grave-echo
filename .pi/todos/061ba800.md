{
  "id": "061ba800",
  "title": "Phase 2.2d: Zone system (overworld + dungeon sub-areas)",
  "tags": [
    "phase-2",
    "map",
    "worldgen",
    "zones"
  ],
  "status": "done",
  "created_at": "2026-02-15T03:35:45.367Z"
}

## Goal
Introduce the concept of zones within a generated map. A zone is a cluster of rooms with
a shared theme and purpose — either "overworld" (open, exploratory) or "dungeon" (tight,
dangerous). This implements the region rhythm from `docs/world.md`: overworld → dungeon →
overworld → dungeon → boss dungeon.

## Read First
- `AGENTS.md` — project constraints
- `docs/world.md` — "Game Rhythm (General)" section, Verdant Threshold structure

## Dependencies
- Requires TODO-97193fc6 (Phase 2.2a) — larger map, varied rooms
- Requires TODO-ebed0a22 (Phase 2.2b) — room tags, spawn points
- Requires TODO-fa6e71e0 (Phase 2.2c) — room graph, intensity curve, critical path

## Requirements

### 1. Zone Concept

```typescript
type ZoneType = "overworld" | "dungeon";

interface Zone {
  type: ZoneType;
  name: string;           // e.g., "Corrupted Forest", "The Hollow Warren"
  rooms: number[];        // indices into the room array
  intensity: number;      // 0.0-1.0, from the intensity curve
  hasBoss: boolean;
}
```

A zone groups rooms that share a theme. The generator assigns rooms to zones based on
the critical path and graph structure.

### 2. Zone Layout
Use the critical path from Phase 2.2c to define zones along it:

```
Zone 1: Overworld (rooms at depth 0-2)
  → Zone 2: Minor Dungeon (rooms at depth 3-4, branching off critical path)
Zone 3: Overworld (rooms at depth 3-5, back on critical path)
  → Zone 4: Minor Dungeon (rooms at depth 5-6, branching off)
Zone 5: Boss Dungeon (rooms at depth 6+, end of critical path)
```

Overworld zones: larger rooms, wider corridors, more spread out.
Dungeon zones: smaller rooms, narrow corridors, denser layout.

### 3. Zone-Specific Generation
Modify room generation to respect zones. Rather than generating all rooms then
assigning zones, generate in zone order:

1. Generate overworld zone 1 rooms (3-4 rooms, larger, spread)
2. Generate dungeon zone 1 rooms (3-4 rooms, smaller, clustered)
3. Generate overworld zone 2 rooms (3-4 rooms)
4. Generate dungeon zone 2 rooms (3-4 rooms)
5. Generate boss dungeon rooms (3-5 rooms, includes the boss room)

Each zone's rooms connect to each other internally and to the adjacent zone via a
transition corridor.

### 4. Zone Transitions
Where two zones meet, place a visually distinct transition:
- Overworld → Dungeon: a doorway or entrance tile (future: distinct glyph)
- The transition should be a narrow corridor (1 tile wide) to create a chokepoint
  that feels like "entering" the dungeon

### 5. Zone-Specific Tile Themes (Visual Only)
Different floor/wall colors per zone type to visually distinguish areas:

- **Overworld**: floor `·` in green/dark-green, walls in brown
- **Dungeon**: floor `·` in gray, walls in standard gray (current look)
- **Boss dungeon**: floor `·` in dark-red/maroon, walls in dark-red

This is cosmetic — just different `fg`/`bg` values on floor and wall tiles per zone.
No new tile types needed.

### 6. Zone-Aware Population
Update the populator to use zone context:

- **Overworld zones**: fewer enemies per room, more items scattered
- **Dungeon zones**: more enemies per room, items concentrated in loot rooms
- **Boss dungeon**: highest enemy density, boss in final room
- **Zone transitions**: empty or single guard enemy

### 7. DungeonResult Update
The generator return type should include zone data:

```typescript
interface DungeonResult {
  map: GameMap;
  rooms: Room[];
  zones: Zone[];
  graph: RoomGraph;
}
```

## Open Questions
- Should overworld rooms use a different generation algorithm (cellular automata for
  organic caves vs rectangular rooms for dungeons)? Probably yes but could be a
  follow-up todo.
- How large should the total map be to fit 5 zones? Probably 150×100 or larger.
  The viewport handles any size.

## Tests
- Unit test: zones are created along the critical path
- Unit test: each room belongs to exactly one zone
- Unit test: zone intensity increases from first to last
- Unit test: boss zone contains the boss room
- Manual: overworld and dungeon areas are visually distinct (different colors)
- Manual: transitioning from overworld to dungeon feels like entering a tighter space
- Manual: difficulty ramps across zones, not just across rooms

## Definition of Done
- Rooms are grouped into zones (overworld/dungeon)
- Zone order follows the critical path with alternating types
- Zones have distinct visual themes (tile colors)
- Population respects zone context
- The generated map feels like a journey: open → tight → open → tight → boss
- `bun test` passes
