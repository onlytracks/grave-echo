{
  "id": "f58f7955",
  "title": "Debug panel rework — split bottom into messages + entity metrics + equipment",
  "tags": [
    "ui",
    "debug",
    "renderer",
    "quality-of-life"
  ],
  "status": "open",
  "created_at": "2026-02-16T00:18:07.763Z"
}

## Goal
When debug mode is toggled on, the bottom row splits into three columns:
messages (all, including debug), entity metrics dashboard, and equipment.
Currently the debug panel replaces the message log entirely and crams
entity info + messages into one panel — entity list pushes messages off screen.

## Current Behavior
- Debug off: bottom row = `[Message Log | Equipment]`
- Debug on: bottom row = `[Debug Panel (entities + all messages) | Equipment]`
- Debug panel replaces message log region entirely
- Entity list at top eats into message space — with 10+ enemies, only a few
  messages visible

## New Behavior
- Debug off: bottom row = `[Message Log | Equipment]` (unchanged)
- Debug on: bottom row = `[All Messages | Entity Metrics | Equipment]`

### Three-Column Layout When Debug Active

```
┌─ Messages ─────────────────┬─ Entities ──────────────┬─ Equipment ──┐
│ [move] Player (5,3)→(5,4)  │ Acted:N Mv:3 2nd:N     │ Wpn: Sword   │
│ [sense] revealed 3 tiles   │ Status: idle            │ Arm: Chain   │
│ You attack The ϛ for 4 dmg │ ─────────────────────── │ Ac1: Ring    │
│ [combat] Player[hp=20/20   │ ġ#4  11/11 idle d=99   │ Ac2: --      │
│   str=5]→ϛ#10[hp=8/12]    │ ϛ#7  10/10 idle d=59   │              │
│ The ϛ dies!                │ a#9   9/9  alert 2/5 ⚠ │              │
│ Iron Sword dropped!        │ Ġ#14 28/28 idle d=76   │              │
│ --- Turn 4 ---             │ ϛ#19 12/12 idle d=55   │              │
│ [turn] Player turn start   │                        │              │
└────────────────────────────┴────────────────────────┴──────────────┘
```

### Messages Column (Left)
- Shows ALL messages: gameplay + debug, same as current debug panel
- Color-coded by prefix: `[combat]` red, `[ai]` cyan, `[move]` darkGray,
  `[sense]` yellow, `[turn]` magenta, `[spawn]` green, gameplay white
- Turn separators: `--- Turn N ---`
- Auto-scrolls to most recent
- Same rendering logic as current debug panel message section

### Entity Metrics Column (Middle)
- **Player turn state** (line 1): `Acted:N Mv:3 2nd:N`
- **Awareness status** (line 2): `Status: idle` or `Alert: ϛ#10 sensing you`
- **Separator line**
- **AI entity list** (sorted by distance):
  ```
  ġ#4 11/11 idle d=99
  ϛ#7 10/10 alert 2/5 d=3 LOS:Y ⚠
  a#9  9/9  idle d=56
  ```
  Format: `glyph#id hp/max state dist [LOS] [⚠]`
  - Alert entities show `alert turnsWithout/alertDuration`
  - Entities sensing player get `⚠` marker and yellow color
  - Others in cyan

### Equipment Column (Right)
- Unchanged from current `renderEquipment()`

## Layout Calculation

### Width Distribution
In `calculateLayout()`, when debug mode is active, the bottom row gets
three regions instead of two:

```typescript
// Debug off (current):
// messageLog: leftColWidth
// equipment: rightColWidth

// Debug on:
// debugMessages: ~50% of total width
// debugEntities: ~30% of total width  
// equipment: ~20% of total width (same as rightColWidth, min 20)
```

Concrete approach — add a `debug` flag to `calculateLayout()`:

```typescript
export function calculateLayout(
  screenWidth: number,
  screenHeight: number,
  debug?: boolean,
): LayoutRegions {
  // ... existing top row logic unchanged ...

  if (debug) {
    const equipWidth = rightColWidth; // keep same
    const remaining = screenWidth - equipWidth;
    const entityWidth = Math.max(24, Math.floor(remaining * 0.4));
    const msgWidth = remaining - entityWidth;

    return {
      // ... top row unchanged ...
      messageLog: { x: 0, y: topRowHeight, width: msgWidth, height: bottomRowHeight },
      debugEntities: { x: msgWidth, y: topRowHeight, width: entityWidth, height: bottomRowHeight },
      equipment: { x: msgWidth + entityWidth, y: topRowHeight, width: equipWidth, height: bottomRowHeight },
    };
  }
  // ... existing non-debug layout ...
}
```

### LayoutRegions Update
Add optional `debugEntities` region:

```typescript
export interface LayoutRegions {
  gameGrid: Region;
  playerStats: Region;
  targetInfo: Region;
  messageLog: Region;
  equipment: Region;
  debugEntities?: Region;
}
```

## Rendering

### New: renderDebugEntities()
Extract entity metrics rendering from current `renderDebugPanel()` into
`renderDebugEntities()` in `debug-panel.ts`:

```typescript
export function renderDebugEntities(
  renderer: Renderer,
  world: World,
  region: Region,
  map?: GameMap,
): void {
  renderer.drawBox(region.x, region.y, region.width, region.height, "Entities");
  // Player turn state line
  // Awareness status line  
  // Separator
  // AI entity list (compact format)
}
```

### Updated: renderDebugMessages()
Rename/refactor to just render the message list with debug coloring:

```typescript
export function renderDebugMessages(
  renderer: Renderer,
  region: Region,
  messages: readonly TaggedMessage[],
): void {
  renderer.drawBox(region.x, region.y, region.width, region.height, "Messages");
  // All messages with turn separators and color coding
}
```

### Game.ts render() Changes
```typescript
if (this.debugVisible) {
  const debugLayout = calculateLayout(screenWidth, screenHeight, true);
  
  renderDebugMessages(
    this.renderer,
    debugLayout.messageLog,
    this.messages.getAllMessagesWithTurns(),
  );
  
  if (debugLayout.debugEntities) {
    renderDebugEntities(
      this.renderer,
      this.world,
      debugLayout.debugEntities,
      this.map,
    );
  }
  
  renderEquipment(this.renderer, this.world, debugLayout.equipment);
} else {
  renderMessageLog(...);
  renderEquipment(...);
}
```

## Entity Metrics — Compact Format
With a min width of 24, each entity line needs to be tight:

```
ġ#4 11/11 idle d=99       (22 chars)
ϛ#7 10/10 alrt 2/5 d=3 ⚠  (25 chars)
```

- `alrt` instead of `alert` to save space
- Drop `vis=N` and `LOS:N` — only show `LOS:Y` when true (saves space,
  LOS:N is the common uninteresting case)
- Keep `⚠` for "actively sensing player"

## Files to Change
- `src/renderer/layout.ts` — add debug flag, debugEntities region, three-column layout
- `src/renderer/panels/debug-panel.ts` — split into renderDebugEntities + renderDebugMessages
- `src/game.ts` — use debug layout when debugVisible, render three panels

## Tests
- Manual: toggle debug, verify three-column layout appears
- Manual: messages show all debug + gameplay with colors
- Manual: entity panel shows turn state + entity list
- Manual: equipment panel unchanged
- Manual: resize terminal, layout adapts
- `bun test` passes

## Definition of Done
- Debug mode shows three-column bottom row: messages | entities | equipment
- Messages column shows all messages (gameplay + debug) with color coding
- Entity metrics column shows player turn state + AI entity list
- Equipment column unchanged
- Non-debug mode unchanged
- No information lost from current debug panel
- `bun test` passes
