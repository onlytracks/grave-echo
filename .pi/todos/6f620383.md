{
  "id": "6f620383",
  "title": "Phase 3.3: Item variety — armor, accessories, consumables, weapon types",
  "tags": [
    "phase-3",
    "items",
    "ecs",
    "loot"
  ],
  "status": "in_progress",
  "created_at": "2026-02-15T05:42:40.110Z",
  "assigned_to_session": "aaace50d-ac9a-491d-a334-a2d6cdaacc11"
}

## Goal
Expand the item system from 3 items to a full spread: multiple weapon types, armor,
accessories with passive bonuses, and consumable variety. Add the Armor and Accessory
ECS components, expand the Equipment component to support all slots from `docs/items.md`,
and populate the item pool so exploration feels rewarding.

## Read First
- `AGENTS.md` — universal entity system, items are entities
- `docs/items.md` — equipment slots, weapon table, rarity, weight ranges, consumables
- `docs/combat.md` — weapon categories, attack types (melee/reach/ranged)

## Existing Code Context

### Components (`src/ecs/components.ts`)
```typescript
interface Item { name: string; weight: number; rarity: "common" | ... }
interface Weapon { damage: number; range: number; weaponType: "sword" | "bow" }
interface Consumable { effectType: "heal"; power: number; charges: number; maxCharges: number }
interface Equipment { weapon: number | null }
```

No Armor or Accessory components. Equipment only has weapon slot.

### Item Factory (`src/items/item-factory.ts`)
Three factory functions: `createIronSword`, `createShortBow`, `createHealingPotion`.
Each creates an entity with Position, Renderable, Item, and a type component (Weapon
or Consumable).

### Populator (`src/map/room-populator.ts`)
`ITEM_POOL` array with weighted entries. Picks randomly during room population.

### Combat (`src/ecs/systems/combat.ts`)
Damage formula: `baseDamage - defenderStats.defense + variance`. Defense comes from
`Stats.defense` only — no armor contribution yet.

## Requirements

### 1. Armor Component
```typescript
interface Armor {
  defense: number;
  speedPenalty: number;  // 0 for light, 1-2 for heavy
  armorType: "light" | "medium" | "heavy";
}
```

Add to ComponentMap.

### 2. Accessory Component
```typescript
interface Accessory {
  slot: "accessory";  // future-proofing for ring vs amulet distinction
  bonuses: StatBonus[];
}

interface StatBonus {
  stat: "strength" | "defense" | "speed" | "maxHealth" | "critChance" | "critDamage";
  value: number;  // flat bonus, not percentage (keep simple for now)
}
```

Add Accessory and StatBonus to ComponentMap (StatBonus as a nested type, not a component).

### 3. Expand Equipment Component
```typescript
interface Equipment {
  weapon: number | null;
  armor: number | null;
  accessory1: number | null;
  accessory2: number | null;
}
```

Update all code that references `Equipment` to handle the new slots.

### 4. Expand Weapon Component
```typescript
type WeaponType = "sword" | "axe" | "mace" | "spear" | "halberd" | "bow" | "crossbow" | "staff" | "wand";
type AttackType = "melee" | "reach" | "ranged";

interface Weapon {
  damage: number;
  range: number;
  weaponType: WeaponType;
  attackType: AttackType;
  defenseBonus: number;  // for shield weapons (Sword & Shield, Mace & Shield)
}
```

Note: attackType and range are used by Phase 3.1 (ranged combat) but the types should
be defined here. If 3.1 isn't done yet, melee still uses bump-to-attack and the extra
fields are stored but unused. No dependency conflict.

### 5. Expand Consumable Component
```typescript
type EffectType = "heal" | "speed" | "strength" | "defense";

interface Consumable {
  effectType: EffectType;
  power: number;
  duration: number;    // turns the effect lasts (0 = instant, like heal)
  charges: number;
  maxCharges: number;
}
```

New effect types:
- `"heal"` — restore HP (existing, instant)
- `"speed"` — +1 movement for N turns
- `"strength"` — +2 attack power for N turns
- `"defense"` — +2 defense for N turns

Buff duration tracking requires a new component or system — see requirement 9.

### 6. Armor in Combat
Update `src/ecs/systems/combat.ts` damage formula to include equipped armor:

```typescript
const armorEntity = defenderEquipment?.armor ?? null;
const armor = armorEntity !== null ? world.getComponent(armorEntity, "Armor") : null;
const totalDefense = defenderStats.defense + (armor?.defense ?? 0);
const damage = Math.max(1, baseDamage - totalDefense + variance);
```

Also factor in weapon defenseBonus (for shield weapons):
```typescript
const defenderWeapon = defenderEquipment?.weapon ?? null;
const defWeapon = defenderWeapon !== null ? world.getComponent(defenderWeapon, "Weapon") : null;
const totalDefense = defenderStats.defense + (armor?.defense ?? 0) + (defWeapon?.defenseBonus ?? 0);
```

### 7. Armor Speed Penalty
When armor is equipped, reduce effective speed:

```typescript
const armorPenalty = armor?.speedPenalty ?? 0;
const effectiveSpeed = stats.speed - armorPenalty;
```

Apply in turn reset (when setting movementRemaining) and anywhere speed is read.

### 8. Accessory Passive Bonuses
Accessory bonuses should be applied when calculating effective stats. Rather than
modifying Stats directly (which gets messy), create a helper:

```typescript
function getEffectiveStats(world: World, entity: Entity): EffectiveStats {
  const base = world.getComponent(entity, "Stats")!;
  const equipment = world.getComponent(entity, "Equipment");
  // Sum bonuses from accessories
  let str = base.strength, def = base.defense, spd = base.speed;
  for (const slot of [equipment?.accessory1, equipment?.accessory2]) {
    if (slot === null || slot === undefined) continue;
    const acc = world.getComponent(slot, "Accessory");
    if (!acc) continue;
    for (const bonus of acc.bonuses) {
      if (bonus.stat === "strength") str += bonus.value;
      if (bonus.stat === "defense") def += bonus.value;
      if (bonus.stat === "speed") spd += bonus.value;
    }
  }
  return { strength: str, defense: def, speed: spd, ...etc };
}
```

Use `getEffectiveStats()` in combat, turn reset, and UI display. This keeps base
Stats clean and makes bonuses easy to add/remove.

Put this in a new `src/ecs/systems/stats.ts` utility.

### 9. Buff System (Minimal)
For buff consumables (speed/strength/defense potions), track active buffs:

```typescript
interface ActiveBuff {
  stat: "strength" | "defense" | "speed";
  value: number;
  turnsRemaining: number;
}

interface Buffs {
  active: ActiveBuff[];
}
```

Add `Buffs` component to ComponentMap. `getEffectiveStats()` also sums active buff
values. A `processBuffs()` system decrements `turnsRemaining` each turn and removes
expired buffs.

### 10. Equip/Unequip Armor and Accessories
Update `src/ecs/systems/inventory.ts`:
- `equipArmor(world, entity, itemEntity, messages)` — equip to armor slot
- `equipAccessory(world, entity, itemEntity, messages)` — equip to first empty
  accessory slot, or replace accessory1 if both full
- Generalize `equip()` to detect item type and route to correct slot
- Unequip should work for any slot

The inventory screen (Phase 3.2) should show `[E]` for any equipped item regardless
of slot type. `e` key should work for armor and accessories too.

### 11. Item Factory Expansion
Add factory functions in `src/items/item-factory.ts` for:

**Weapons** (one per category):
- `createIronSword` (existing) — melee, range 1, dmg 5, wt 6
- `createSwordAndShield` — melee, range 1, dmg 4, defBonus 2, wt 7
- `createBattleAxe` — melee, range 1, dmg 7, wt 8
- `createMaceAndShield` — melee, range 1, dmg 4, defBonus 2, wt 6
- `createIronSpear` — reach, range 2, dmg 4, wt 5
- `createHalberd` — reach, range 2, dmg 6, wt 9
- `createShortBow` (existing) — ranged, range 6, dmg 3, wt 4
- `createCrossbow` — ranged, range 8, dmg 5, wt 6
- `createOakStaff` — ranged, range 4, dmg 4, wt 3
- `createWand` — ranged, range 3, dmg 3, wt 2

**Armor**:
- `createLeatherArmor` — def 2, speedPenalty 0, wt 5, light
- `createChainmail` — def 4, speedPenalty 1, wt 10, medium
- `createPlateArmor` — def 6, speedPenalty 2, wt 15, heavy

**Accessories**:
- `createIronRing` — +1 strength, wt 1
- `createWardAmulet` — +1 defense, wt 1
- `createSwiftBoots` — +1 speed, wt 2

**Consumables**:
- `createHealingPotion` (existing) — heal 8, 3 charges, wt 1
- `createSpeedPotion` — +1 speed for 5 turns, 2 charges, wt 1
- `createStrengthPotion` — +2 strength for 5 turns, 2 charges, wt 1
- `createDefensePotion` — +2 defense for 5 turns, 2 charges, wt 1

All common rarity for now. Rarity-based generation is a future concern.

### 12. Update Item Pool
Update `ITEM_POOL` in `src/map/room-populator.ts` with weighted entries for all
new items. Rough weighting:

- Weapons: weight 2 each (many types, individually rarer)
- Armor: weight 3 (important find)
- Accessories: weight 2 each
- Healing potions: weight 5 (most common consumable)
- Buff potions: weight 2 each

### 13. Renderable Glyphs for New Items
Each item type needs a distinct glyph:

| Type | Char | Color |
|------|------|-------|
| Swords/axes/maces | `/` | white |
| Shield weapons | `+` | white |
| Spear/halberd | `\|` | white |
| Bow | `)` | yellow |
| Crossbow | `}` | yellow |
| Staff | `/` | cyan |
| Wand | `-` | magenta |
| Light armor | `[` | green |
| Medium armor | `[` | brightGreen |
| Heavy armor | `[` | brightWhite |
| Ring | `°` | yellow |
| Amulet | `"` | cyan |
| Boots | `{` | yellow |
| Potion (heal) | `!` | brightRed |
| Potion (speed) | `!` | brightCyan |
| Potion (strength) | `!` | brightYellow |
| Potion (defense) | `!` | brightBlue |

### 14. UI: Player Stats Panel
Update the PlayerStats panel to show:
- Effective stats (including armor, accessory bonuses, active buffs)
- Equipped armor name
- Accessory names
- Active buff indicators with remaining turns

## Tests
- Unit test: Armor component adds to defense in combat formula
- Unit test: Heavy armor reduces movement
- Unit test: Accessory bonuses apply to effective stats
- Unit test: Buff consumable applies temporary buff
- Unit test: Buff expires after N turns
- Unit test: getEffectiveStats sums base + armor + accessories + buffs
- Unit test: Equip armor goes to armor slot
- Unit test: Equip accessory fills first empty slot
- Unit test: Equipment with all 4 slots populated
- Manual: new item types appear in dungeon
- Manual: armor visibly reduces damage taken
- Manual: heavy armor visibly reduces movement
- Manual: buff potions show active effect in UI
- Manual: variety of loot makes exploration feel rewarding
- `bun test` passes

## Definition of Done
- Armor component exists with defense and speed penalty
- Accessory component exists with stat bonuses
- Equipment has weapon, armor, accessory1, accessory2 slots
- Weapon types expanded to all 10 categories with attackType
- Consumable types expanded (heal, speed, strength, defense)
- Buff system tracks temporary effects
- `getEffectiveStats()` utility used everywhere stats are read
- 20+ item factory functions
- Item pool updated with all new items
- Combat formula uses armor + weapon defense bonus
- UI shows effective stats and active buffs
- `bun test` passes
