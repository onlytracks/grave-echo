{
  "id": "67224c37",
  "title": "Phase 1.3: Items, Equipment, and Inventory",
  "tags": [
    "phase-1",
    "items",
    "ecs",
    "systems"
  ],
  "status": "done",
  "created_at": "2026-02-15T01:29:12.693Z"
}

## Goal
Implement the item system: items as entities on the ground, an inventory with weight,
equipment slots, weapon swap as a secondary action, a healing potion consumable, and
combat that uses equipped weapon stats. Three item types: a melee sword, a ranged bow,
and a healing potion.

## Read First
- `AGENTS.md` — project constraints (items are entities, universal entity system)
- `docs/items.md` — full item system design (equipment slots, rarity, weight, consumables)
- `docs/combat.md` — weapon categories, secondary actions, primary actions (using items)

## Dependencies
- Requires: Phase 1.1 (Debug Panel) and Phase 1.2 (Dungeon Generation) completed.
  Items will be placed in dungeon rooms. Debug panel should show inventory/equipment state.

## Existing Code Context
- Components: `src/ecs/components.ts` — `ComponentMap` interface maps component names to types.
  Add new components here and they become available via `world.addComponent()`.
- Combat: `src/ecs/systems/combat.ts` — `attack()` uses `Stats.strength` for damage.
  Needs to be updated to use equipped weapon damage.
- Movement: `src/ecs/systems/movement.ts` — `tryMove()` handles collision. Items on the
  ground should NOT block movement (they are not Collidable).
- Input: `src/input/input-handler.ts` — parses keypresses into InputEvent. Needs new
  event types for pickup, equip, use item, swap weapon.
- Game loop: `src/game.ts` — handles input events and rendering.
- ECS: `src/ecs/world.ts` — World class. Items will be entities in this same world.

## Requirements

### New Components in `src/ecs/components.ts`

```typescript
Item: {
  name: string;
  weight: number;
  rarity: 'common' | 'uncommon' | 'rare' | 'epic' | 'legendary';
}

Weapon: {
  damage: number;
  range: number;
  weaponType: 'sword' | 'bow';
}

Consumable: {
  effectType: 'heal';
  power: number;       // heal amount
  charges: number;
  maxCharges: number;
}

Inventory: {
  items: number[];       // entity IDs of held items
  totalWeight: number;
  carryCapacity: number;
}

Equipment: {
  weapon: number | null;  // entity ID of equipped weapon
}
```

Add all to ComponentMap.

### Item Entities
Items are ECS entities. A sword on the ground has: Position, Renderable, Item, Weapon.
A sword in inventory has: Item, Weapon (no Position — it's not on the map).
A sword equipped has: Item, Weapon, and is referenced by the holder's Equipment.weapon.

**Pickup:** Remove Position + Renderable from item entity. Add item entity ID to
holder's Inventory.items. Update totalWeight.

**Drop:** Add Position + Renderable back. Remove from Inventory.items. Update totalWeight.

**Equip:** Set Equipment.weapon to item entity ID. If something was already equipped,
it goes back to inventory (swap).

### Item Definitions (Hardcoded for Now)
Create helper functions in `src/map/dungeon-generator.ts` or a new `src/items/item-factory.ts`
to spawn items:

**Iron Sword** (Common melee weapon)
- Renderable: `{ char: '/', fg: 'white', bg: 'black' }`
- Item: `{ name: 'Iron Sword', weight: 6, rarity: 'common' }`
- Weapon: `{ damage: 5, range: 1, weaponType: 'sword' }`

**Short Bow** (Common ranged weapon)
- Renderable: `{ char: ')', fg: 'yellow', bg: 'black' }`
- Item: `{ name: 'Short Bow', weight: 4, rarity: 'common' }`
- Weapon: `{ damage: 3, range: 6, weaponType: 'bow' }`

**Healing Potion** (Consumable)
- Renderable: `{ char: '!', fg: 'brightRed', bg: 'black' }`
- Item: `{ name: 'Healing Potion', weight: 1, rarity: 'common' }`
- Consumable: `{ effectType: 'heal', power: 8, charges: 3, maxCharges: 3 }`

### `src/ecs/systems/inventory.ts` — Inventory System

Functions for inventory management:
```typescript
pickup(world: World, entity: number, itemEntity: number): boolean
  // Adds item to inventory if weight allows. Removes Position/Renderable from item.
  // Returns false if over carry capacity.

drop(world: World, entity: number, itemEntity: number): void
  // Removes item from inventory. Adds Position/Renderable back at entity's position.

equip(world: World, entity: number, itemEntity: number): void
  // Equips weapon. If something already equipped, swap it back to inventory.

unequip(world: World, entity: number): void
  // Moves equipped weapon back to inventory.

useConsumable(world: World, entity: number, itemEntity: number, messages: MessageLog): void
  // Use a consumable. For 'heal': restore Health. Decrement charges. Remove if 0 charges.
```

### Weight / Encumbrance
Per docs/items.md:
- `encumbrance = totalWeight / carryCapacity`
- 0-50%: no penalty
- 50-75%: -1 movement per turn
- 75-100%: -2 movement per turn
- 100%+: cannot move

Apply encumbrance penalty in the turn system when calculating movementRemaining:
`movementRemaining = max(0, stats.speed - encumbrancePenalty)`

### Update Combat System
In `src/ecs/systems/combat.ts`:
- If attacker has Equipment with a weapon equipped, use weapon's damage instead of
  Stats.strength: `damage = weapon.damage - defender.defense + variance`
- If no weapon equipped, fall back to Stats.strength (unarmed)
- **Range check:** If weapon range > 1 (bow), the entity should be able to attack targets
  at distance. For now, bump-to-attack still works for melee. Ranged attack via Space key
  targeting tab-selected enemy is a future task. Just use weapon damage for bump attacks.

### Input Changes
Add new InputEvent types in `src/input/input-handler.ts`:
- `e` key → `{ type: 'pickup' }` — pick up item at player's position
- `s` key → `{ type: 'swapWeapon' }` — cycle to next weapon in inventory (secondary action)
- `u` key → `{ type: 'useItem' }` — use first consumable in inventory (primary action, ends turn)

### Game Loop Changes
In `src/game.ts`, handle new input events:
- `pickup`: find item entity at player's Position, call inventory.pickup()
- `swapWeapon`: if player has weapons in inventory, equip next one (secondary action,
  does NOT end turn). Only allowed if secondary action not yet used this turn.
  Add `secondaryUsed: boolean` to TurnActor component.
- `useItem`: find first consumable in inventory, call useConsumable() (primary action,
  ends turn — sets hasActed = true)

### Spawn Items in Dungeon
In `src/index.ts`:
- Place an Iron Sword in room 1 (near the player start)
- Place a Short Bow in room 2
- Place a Healing Potion in room 3
- Give the player an Inventory and Equipment component:
  - Inventory: `{ items: [], totalWeight: 0, carryCapacity: 30 }`
  - Equipment: `{ weapon: null }`

### Update Debug Panel
In `src/renderer/panels/debug-panel.ts`:
- Show player's inventory (item names + weights)
- Show equipped weapon name
- Show encumbrance percentage
- Show items on the ground at player's position

### Message Feedback
All item interactions should produce messages via MessageLog:
- "You pick up Iron Sword"
- "You equip Iron Sword"
- "You swap to Short Bow"
- "You drink Healing Potion (3→2 charges). Healed for 8 HP."
- "Inventory too heavy to pick up Iron Sword"

## Tests

### `src/ecs/systems/__tests__/inventory.test.ts`
- Pickup adds item to inventory, removes Position/Renderable
- Pickup fails when over carry capacity
- Drop removes item from inventory, adds Position/Renderable at entity's position
- Equip sets Equipment.weapon, item stays in inventory
- Equip swaps: old weapon goes to inventory, new weapon equips
- Unequip moves weapon from Equipment to inventory
- UseConsumable: heal restores HP (capped at max), decrements charges
- UseConsumable: item removed from inventory when charges reach 0
- Weight updates correctly on pickup/drop
- Encumbrance penalty calculated correctly at each threshold

### `src/ecs/systems/__tests__/combat.test.ts` (update existing)
- Attack uses weapon damage when weapon is equipped
- Attack uses Stats.strength when no weapon equipped (unarmed)

## Definition of Done
- Items (sword, bow, potion) appear on the dungeon floor with distinct characters
- Player can pick up items with `e` key
- Player can equip weapons with `s` key (secondary action, doesn't end turn)
- Player can use healing potion with `u` key (primary action, ends turn)
- Combat uses equipped weapon damage
- Weight/encumbrance affects movement
- Debug panel shows inventory, equipment, and encumbrance
- Messages provide feedback for all item interactions
- `bun test` passes all new and updated tests
