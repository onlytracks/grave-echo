{
  "id": "0999133f",
  "title": "Phase 3.4: Enemy types — Archer, Guardian, Skulker, Patrol AI patterns",
  "tags": [
    "phase-3",
    "ai",
    "enemies",
    "combat"
  ],
  "status": "pending",
  "created_at": "2026-02-15T05:58:55.064Z"
}

## Goal
Add 4 new AI behavior patterns and enemy entities that use them. Currently only the
Charger pattern exists (move toward target, bump-to-attack). New patterns create
tactical variety: enemies that shoot from range, hold chokepoints, flank, and patrol.
Each enemy type is equipped with appropriate weapons/armor from the item system.

## Read First
- `AGENTS.md` — universal entity system, same rules for all entities
- `docs/combat.md` — AI Behavior Patterns table, Scaling by Act, Telegraphing
- `docs/world.md` — Verdant Threshold enemy roster (Blightvine Creeper, Rotwood
  Archer, Thornback Guardian, Sporecap Swarm, Grove Warden mini-boss)

## Dependencies
- Requires TODO-6f620383 (Phase 3.3) — item variety (weapons/armor for enemies)
- Benefits from TODO-2a03ea80 (Phase 3.1) — ranged combat (Archer pattern needs
  ranged attacks). If 3.1 isn't done, Archer can be implemented but won't shoot —
  it would close to melee range. Better to do 3.1 first.

## Existing Code Context

### AIControlled Component (`src/ecs/components.ts`)
```typescript
interface AIControlled {
  pattern: "charger";
  targetEntity: number | null;
}
```

Only supports "charger" pattern.

### AI System (`src/ecs/systems/ai.ts`)
- `processAI()` — iterates AI entities, checks awareness, dispatches by pattern
- `chargerBehavior()` — moves toward target, bumps to attack, uses all movement
- Single switch statement in processAI for pattern dispatch

### Enemy Creation (`src/map/room-populator.ts`)
- `createGoblin()` — charger pattern, scaled hp/str/def by difficulty + intensity
- `createBoss()` — charger pattern, beefier stats, `G` glyph
- All enemies are the same tactically — walk toward player, hit

### Sensory (`src/ecs/systems/sensory.ts`)
- `hasLineOfSight()` — Bresenham LOS, exported
- `computeVisibleTiles()` — all visible tiles from a point
- `updateAwareness()` — idle/alert transitions for AI entities

## Requirements

### 1. Expand AIControlled Pattern Type
```typescript
interface AIControlled {
  pattern: "charger" | "archer" | "guardian" | "skulker" | "patrol";
  targetEntity: number | null;
  patrolPath?: { x: number; y: number }[];  // for patrol pattern
  patrolIndex?: number;                      // current patrol waypoint
}
```

### 2. Archer Pattern
**Behavior**: Keep distance from target. Attack at range if possible. Retreat if
target gets too close.

```
if target within weapon range AND has LOS:
  if target adjacent or within 2 tiles:
    move AWAY from target (up to movement points)
    then attack if still in range + LOS
  else:
    attack (don't move — save position)
else:
  move toward target until in range
```

Key traits:
- Prefers to maintain distance (weapon range - 1 tiles from target)
- Flees from melee range rather than fighting up close
- Only closes distance when out of weapon range
- Equipped with ranged weapon (bow, crossbow, staff)

Retreat logic: try to move in the opposite direction from the target. If blocked,
try perpendicular directions. Prioritize maintaining LOS while retreating.

### 3. Guardian Pattern
**Behavior**: Hold position. Attack anything that comes within weapon range. Never
chase.

```
if target within weapon range (melee=1, reach=2):
  attack target
else:
  do nothing (stand ground)
```

Key traits:
- Never moves from spawn position
- Effectively a turret — blocks doorways, guards loot rooms
- High defense, moderate damage
- Equipped with reach weapon (spear, halberd) for 2-tile threat zone, or melee
  weapon for 1-tile zone

### 4. Skulker Pattern
**Behavior**: Avoid direct approach. Try to flank the target by moving to a tile
that is adjacent to the target but NOT in the direction the target is facing (or
simply not the most direct path).

```
if adjacent to target:
  attack
else:
  calculate flanking position (adjacent tile on opposite side of target from self)
  if flanking position is reachable:
    move toward flanking position
  else:
    move toward target (fallback to charger behavior)
```

Key traits:
- Tries to get behind or beside the target
- Avoids approaching head-on
- Moderate stats, fast (speed 3-4)
- Equipped with melee weapon (dagger/sword)
- More dangerous in groups (one flanks while others engage front)

Flanking calculation: find the tile adjacent to the target that is farthest from
the skulker's current position (on the opposite side). If multiple options, pick
the one that's walkable and not occupied.

### 5. Patrol Pattern
**Behavior**: Follow a set path between waypoints when idle. Alert behavior switches
to charger (pursue and attack).

```
if alert:
  charger behavior (move toward target, attack)
else (idle):
  move toward next patrol waypoint
  if reached waypoint:
    advance to next waypoint (loop)
```

Key traits:
- Moves when idle (unlike all other patterns which stand still when idle)
- Creates moving threats the player must time around
- Waypoints set during room generation (e.g., patrol between two doorways)
- When alert, becomes a charger — drops patrol to chase
- Returns to patrol when alert → idle (resumes nearest waypoint)

This is the ONLY pattern that acts during idle state. The `processAI` function
currently skips idle entities — add a check: if pattern is "patrol" AND idle,
run patrol movement instead of skipping.

### 6. Enemy Entity Definitions
Create enemy factory functions in a new `src/enemies/enemy-factory.ts` (or expand
the populator). Each enemy is a themed entity with appropriate stats, equipment,
and AI pattern.

**Rotwood Archer** (Verdant Threshold)
- Pattern: archer
- Glyph: `a` / brightYellow
- HP: 6 + scaling, Str: 2, Def: 1, Speed: 2
- Equipped: Short Bow (ranged, range 6)
- Vision: 7
- Alert duration: 4

**Thornback Guardian** (Verdant Threshold)
- Pattern: guardian
- Glyph: `T` / brightGreen
- HP: 15 + scaling, Str: 4, Def: 4, Speed: 1
- Equipped: Iron Spear (reach, range 2), Chainmail
- Vision: 5
- Alert duration: 3

**Blightvine Skulker** (Verdant Threshold)
- Pattern: skulker
- Glyph: `s` / green
- HP: 7 + scaling, Str: 4, Def: 1, Speed: 3
- Equipped: Iron Sword (melee, range 1)
- Vision: 6
- Alert duration: 6

**Hollow Patrol** (Generic)
- Pattern: patrol
- Glyph: `p` / gray
- HP: 10 + scaling, Str: 3, Def: 2, Speed: 2
- Equipped: Sword & Shield (melee, range 1, defBonus 2)
- Vision: 6
- Alert duration: 5
- Patrol path: set by room populator based on room geometry

### 7. Enemy Equipment as Entities
Enemies should be equipped using the same item entity system as the player. When
creating an Archer enemy:

```typescript
const bow = createShortBow(world, 0, 0);  // create weapon entity
world.removeComponent(bow, "Position");     // not on ground
// Add to enemy inventory and equip
inventory.items.push(bow);
equipment.weapon = bow;
```

This means when enemies die, their weapon exists as an entity that could be dropped
as loot (future feature — for now, just destroy enemy + equipment on death).

### 8. Equip Enemies with Items
Add Inventory and Equipment components to all enemies. Currently enemies have neither.
Every enemy entity needs:

```typescript
world.addComponent(enemy, "Inventory", { items: [weaponId], totalWeight: ..., carryCapacity: 50 });
world.addComponent(enemy, "Equipment", { weapon: weaponId, armor: armorId, accessory1: null, accessory2: null });
```

This is required for the combat system to read enemy weapon damage/range.

### 9. Update Room Populator
Update `src/map/room-populator.ts` to spawn varied enemies based on room tags
and intensity:

| Room Tag | Enemy Mix |
|----------|-----------|
| combat (low intensity) | 1-2 chargers |
| combat (mid intensity) | 1 charger + 1 archer OR 2 skulkers |
| combat (high intensity) | 1 guardian + 1 archer + 1 skulker |
| boss | Boss entity (existing) + 1-2 chargers |
| transition | 1 patrol (if corridor connects rooms) |
| loot | 1 guardian (guards the loot) |

Intensity thresholds drive which enemy types appear. Low intensity rooms get
simple chargers. High intensity rooms get mixed tactical groups.

### 10. Patrol Waypoint Generation
For patrol enemies, generate waypoints from the room geometry:

- In a corridor: patrol between the two ends
- In a room: patrol between two doorways or along a wall
- Waypoints are 2-4 positions forming a loop

The populator sets `patrolPath` on the AIControlled component when creating a
patrol enemy. Simple approach: pick 2 random walkable tiles near the room edges.

### 11. Update processAI Dispatch
Add cases to the switch in `processAI()`:

```typescript
switch (ai.pattern) {
  case "charger": chargerBehavior(world, map, entity, messages); break;
  case "archer":  archerBehavior(world, map, entity, messages); break;
  case "guardian": guardianBehavior(world, map, entity, messages); break;
  case "skulker":  skulkerBehavior(world, map, entity, messages); break;
  case "patrol":   patrolBehavior(world, map, entity, messages); break;
}
```

### 12. Debug Messages
Each AI pattern should log its decisions:

```
[ai] Archer#12: retreating from player (d=2), moving (30,8)→(31,8)
[ai] Archer#12: attacking player at range 5
[ai] Guardian#7: holding position, target out of range (d=4)
[ai] Guardian#7: attacking player at range 2 (spear)
[ai] Skulker#15: flanking toward (14,13), opposite side of player
[ai] Patrol#9: patrolling toward waypoint (20,5)
[ai] Patrol#9: alert! switching to chase
```

## Edge Cases
- **Archer cornered**: no retreat path available → attacks from current position
  even at close range (fallback, don't freeze)
- **Guardian target leaves range**: does nothing, waits. Stays alert for
  alertDuration turns then goes idle.
- **Skulker can't find flank path**: falls back to charger behavior (direct approach)
- **Patrol reaches waypoint while idle**: advances to next, loops to start
- **Patrol alerted mid-patrol**: drops patrol, chases. On return to idle, resumes
  from nearest waypoint to current position.
- **Enemy with ranged weapon but 3.1 not implemented**: falls back to charger
  behavior (close to melee). The weapon entity still exists, just unused for
  ranged attacks. No crash.

## Tests
- Unit test: Archer moves away when target is adjacent
- Unit test: Archer attacks when target is in range + LOS
- Unit test: Archer closes distance when target is out of range
- Unit test: Guardian never moves from initial position
- Unit test: Guardian attacks when target enters weapon range
- Unit test: Guardian does nothing when target is out of range
- Unit test: Skulker calculates flanking position correctly
- Unit test: Skulker falls back to charger when flanking blocked
- Unit test: Patrol follows waypoints when idle
- Unit test: Patrol switches to charger when alert
- Unit test: Enemy equipment contributes to combat (weapon damage)
- Manual: Archer enemies kite the player (retreat + shoot)
- Manual: Guardian enemies block doorways effectively
- Manual: Skulker enemies try to get behind the player
- Manual: Patrol enemies move predictably, player can time engagement
- Manual: Mixed enemy groups create tactical puzzles
- `bun test` passes

## Definition of Done
- 4 new AI patterns implemented (archer, guardian, skulker, patrol)
- Pattern dispatch in processAI for all 5 patterns
- 4 new enemy entity types with themed stats and equipment
- Enemies carry weapon/armor entities (universal system)
- Room populator spawns varied enemies based on intensity
- Patrol enemies move when idle, chase when alert
- Debug messages for all AI decisions
- `bun test` passes
