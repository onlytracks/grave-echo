{
  "id": "fa6e71e0",
  "title": "Phase 2.2c: Room graph + intensity curve",
  "tags": [
    "phase-2",
    "map",
    "worldgen",
    "pacing"
  ],
  "status": "done",
  "created_at": "2026-02-15T03:35:13.599Z"
}

## Goal
Build a graph of room connections so the generator understands spatial relationships.
Use graph distance from the entry room to create an intensity curve — rooms farther from
entry have harder enemies, better loot, and denser encounters. This is the foundation for
the region rhythm described in `docs/world.md`.

## Read First
- `AGENTS.md` — project constraints
- `docs/world.md` — "Game Rhythm (General)" section, intensity pacing table

## Dependencies
- Requires TODO-97193fc6 (Phase 2.2a) — larger map, varied rooms
- Requires TODO-ebed0a22 (Phase 2.2b) — room tags, spawn points, populator

## Requirements

### 1. Room Graph (`src/map/room-graph.ts`)
After dungeon generation, build a graph of room connectivity:

```typescript
interface RoomGraph {
  rooms: Room[];
  edges: [number, number][];  // pairs of room indices
  getNeighbors(roomIndex: number): number[];
  getDistance(fromIndex: number, toIndex: number): number;  // shortest path in rooms
}

function buildRoomGraph(rooms: Room[], map: GameMap): RoomGraph
```

Two rooms are connected if a corridor exists between them (flood-fill from one room's
floors should reach the other's without passing through a third room, or simpler: track
corridor connections during generation).

Easier approach: track connections during corridor carving in the generator. When
`carveCorridor(roomA, roomB)` is called, record the edge.

### 2. Graph Distance
Compute shortest-path distance (in room hops) from the entry room to every other room
using BFS. Store as `depth` on each room:

```typescript
interface Room {
  // ... existing fields
  depth: number;  // 0 = entry, 1 = adjacent to entry, etc.
}
```

### 3. Intensity Curve
Define intensity as a function of depth:

```typescript
function roomIntensity(depth: number, maxDepth: number): number
// Returns 0.0 - 1.0
```

Simple linear ramp for now: `intensity = depth / maxDepth`. Can be tuned later to
create tension curves (ramp → plateau → spike for boss).

### 4. Intensity-Driven Tag Assignment
Improve tag assignment from Phase 2.2b to use intensity:

- Depth 0 → `"entry"` (always)
- Low intensity (0.0-0.3) → `"combat"` with few enemies, `"loot"` rooms
- Mid intensity (0.3-0.6) → `"combat"` with more enemies, occasional `"loot"`
- High intensity (0.6-0.9) → dense `"combat"`, rare `"loot"`
- Max depth → `"boss"` — the room farthest from entry

### 5. Intensity-Driven Population
Update the room populator to use intensity when placing entities:

- **Enemy count**: scales with intensity (1 enemy at low, 2-3 at high)
- **Enemy stats**: multiply base stats by `1 + intensity * 0.5` (50% stronger at max)
- **Item rarity**: higher intensity → higher chance of Uncommon/Rare items
- **Item count in loot rooms**: more items in deeper loot rooms

### 6. Critical Path
Identify the "critical path" — the shortest route from entry to boss room. Rooms on
the critical path should be `"combat"` or `"transition"`, never empty. Rooms off the
critical path can be `"loot"` or `"empty"` — optional exploration rewards.

```typescript
interface RoomGraph {
  // ... existing
  criticalPath: number[];  // room indices from entry to boss
}
```

### 7. Minimap Data (Optional Stretch)
The room graph naturally supports a future minimap — each room as a node, edges as
connections, player's current room highlighted. Don't build the minimap UI yet, but
ensure the graph data would support it.

## Tests
- Unit test: room graph has correct edges for a known layout
- Unit test: BFS depth is correct (entry=0, adjacent=1, etc.)
- Unit test: intensity increases with depth
- Unit test: boss room is at or near max depth
- Unit test: critical path connects entry to boss
- Manual: early rooms feel easier (fewer, weaker enemies)
- Manual: deep rooms feel harder (more, stronger enemies)
- Manual: boss room is the farthest room with a tougher enemy

## Definition of Done
- Room graph built from dungeon generation with edges and BFS depth
- Intensity curve computed from depth
- Tag assignment uses intensity (not just random)
- Populator scales enemy count/stats and item rarity by intensity
- Critical path identified from entry to boss
- Difficulty ramps noticeably as player explores deeper
- `bun test` passes
