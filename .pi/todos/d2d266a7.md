{
  "id": "d2d266a7",
  "title": "Show Tab-targeted entity's vision range as red-tinted overlay",
  "tags": [
    "quality-of-life",
    "ui",
    "renderer",
    "tactical"
  ],
  "status": "open",
  "created_at": "2026-02-15T06:38:28.383Z"
}

## Goal
When the player Tab-targets any entity that has a Senses component, show that
entity's vision range on the map as a red-tinted overlay. Only tiles within BOTH
the player's FOV and the target's vision range are tinted. This lets the player
plan movement around enemy blind spots, corridors, and walls.

## Existing Code

### Game Grid Renderer (`src/renderer/panels/game-grid.ts`)
Already receives `targetEntity` and renders:
- Target entity with red background highlight
- LOS line from player to target (red `darkGray` tiles)

### Vision Computation (`src/ecs/systems/sensory.ts`)
`computeVisibleTiles(map, originX, originY, range)` — returns `Set<string>` of
visible tile keys. Already used for player FOW and enemy awareness. Can be reused
directly for the target's vision.

### TargetSelection Component
`TargetSelection.targetEntity` — the Tab-selected entity. Works for any entity
(enemies, NPCs, etc.), not just enemies.

## Requirements

### 1. Compute Target Vision Tiles
In `renderGameGrid()`, when `targetEntity` is set and has `Senses` + `Position`:

```typescript
let targetVision: Set<string> | null = null;
if (targetEntity != null) {
  const targetPos = world.getComponent(targetEntity, "Position");
  const targetSenses = world.getComponent(targetEntity, "Senses");
  if (targetPos && targetSenses) {
    targetVision = computeVisibleTiles(
      map, targetPos.x, targetPos.y, targetSenses.vision.range
    );
  }
}
```

### 2. Render Red Tint on Tiles
During the tile rendering loop, for tiles that are:
- In the player's `visibleTiles` (player can see them)
- In the target's `targetVision` (target can see them)
- NOT occupied by an entity (don't override entity rendering)

Tint the floor tile with a dark red background:

```typescript
if (visibleTiles.has(key)) {
  const inTargetVision = targetVision?.has(key) ?? false;
  const bg = inTargetVision ? "darkRed" : tile.bg as Color;
  renderer.drawCell(innerX + dx, innerY + dy, tile.char, tile.fg as Color, bg);
}
```

This creates a subtle danger zone overlay — the player sees which tiles the
targeted entity can observe.

### 3. Color Choice
- `darkRed` background on floor tiles in the danger zone
- Walls within vision range: no tint (they block vision, not useful to highlight)
- Only tint walkable tiles — these are the tiles where standing = being seen

The existing target highlight (red bg on the entity itself) and LOS line (red bg
on path tiles) remain unchanged. The vision overlay is a third layer underneath.

### 4. Performance
`computeVisibleTiles` does Bresenham raycasting over a diamond of tiles. For vision
range 6-8, that's ~100-200 tiles — trivial. Only computed once per render frame,
only when a target is selected.

Cache consideration: the target's vision doesn't change between renders unless the
target moves. Could cache by target entity + position, but premature — the
computation is fast enough to not matter.

### 5. Works for Any Entity
Since this uses `Senses` component, it works for:
- Enemies (plan approach, find blind spots)
- NPCs (if they get Senses in the future)
- Even the player targeting themselves (see your own range — less useful but free)

Entities without `Senses` (items, etc.) simply show no overlay.

### 6. darkRed Color
Check that `darkRed` exists in the renderer's Color type. If not, add it.
ANSI 256-color: `\x1b[48;5;52m` (dark red background).

## Visual Result
```
 ░░░░░░░░░░░░░░
 ░░░▓▓▓▓▓░░░░░░    ▓ = wall
 ░░░▓·····▓░░░░    · = floor (bright, player FOV)
 ░░░▓·····▓░░░░    · = floor with dark red bg (target vision)
 ░░░▓··g··▓░░░░    g = targeted enemy (red bg, white fg)
 ░░░▓·····▓░░░░    @ = player
 ░░░▓▓·▓▓▓░░░░
 ░░░░░·░░░░░░░░    Tiles outside the door are NOT tinted
 ░░░░░·░░░░░░░░    because the enemy can't see through walls
 ░░░░░@░░░░░░░░
```

The player can see the enemy's blind spots — behind walls, around corners,
outside its range — and plan movement accordingly.

## Files to Change
- `src/renderer/panels/game-grid.ts` — add target vision overlay in tile loop
- `src/renderer/renderer.ts` — add `darkRed` to Color type if missing
- `src/renderer/ansi-renderer.ts` — add `darkRed` ANSI code if missing

## Import Needed
- `computeVisibleTiles` from `src/ecs/systems/sensory.ts` into game-grid.ts
- `GameMap` already imported

## Definition of Done
- Tab-targeting an entity with Senses shows its vision range as dark red floor tiles
- Only tiles in player's FOV are tinted (no revealing hidden areas)
- Only walkable tiles tinted (walls don't get red bg)
- Entities without Senses show no overlay
- LOS line and target highlight still render on top
- No visible performance impact
- `bun test` passes
