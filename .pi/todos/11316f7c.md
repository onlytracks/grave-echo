{
  "id": "11316f7c",
  "title": "Phase 2.2e: Stairs + multi-floor dungeons",
  "tags": [
    "phase-2",
    "map",
    "worldgen",
    "floors"
  ],
  "status": "pending",
  "created_at": "2026-02-15T03:36:16.482Z"
}

## Goal
Add stairs that connect multiple dungeon floors within a zone. Minor dungeons are 1-2
floors. The boss dungeon is 2-3 floors. This creates vertical depth and makes dungeons
feel like distinct places rather than flat room clusters.

## Read First
- `AGENTS.md` — project constraints
- `docs/world.md` — main dungeon is "multi-floor", minor dungeons are 5-8 rooms

## Dependencies
- Requires TODO-061ba800 (Phase 2.2d) — zone system

## Requirements

### 1. Stair Tiles
Add new tile types for stairs:

```typescript
export const STAIRS_DOWN_TILE: Tile = {
  type: TileType.StairsDown,
  char: "▼",  // or ">" traditionally — pick from glyph reference
  fg: "brightYellow",
  bg: "black",
  walkable: true,
  transparent: true,
};

export const STAIRS_UP_TILE: Tile = {
  type: TileType.StairsUp,
  char: "▲",  // or "<"
  fg: "brightYellow",
  bg: "black",
  walkable: true,
  transparent: true,
};
```

Add `StairsDown` and `StairsUp` to `TileType` enum.

### 2. Multi-Floor Map
A dungeon zone can span multiple floors. Each floor is its own `GameMap`. The zone
tracks which maps belong to it:

```typescript
interface DungeonFloor {
  map: GameMap;
  rooms: Room[];
  depth: number;  // 0 = top floor, 1 = next down, etc.
  stairsDown?: { x: number; y: number };  // position of down stairs
  stairsUp?: { x: number; y: number };    // position of up stairs
}

interface Zone {
  // ... existing fields
  floors: DungeonFloor[];
}
```

### 3. Floor Transitions
When the player walks onto a stairs tile, transition to the connected floor:
- **Stairs down**: move to the next floor's `stairsUp` position
- **Stairs up**: move to the previous floor's `stairsDown` position

This requires the Game to track which floor the player is on and swap the active map:

```typescript
// In Game class
private currentFloor: number = 0;
private floors: GameMap[];  // or reference through zones
```

Input system: walking onto stairs doesn't auto-transition. The player must press
Enter (interact) while standing on stairs to use them. This prevents accidental
transitions.

### 4. Entity Scope
Entities exist on a specific floor. When changing floors:
- Entities on the old floor are deactivated (not destroyed — player might return)
- Entities on the new floor are activated
- The player entity transfers between floors

Options:
- **Tag entities with floor index** — add a `Floor` component: `{ floorIndex: number }`
- **Systems skip entities not on current floor** — check floor before processing

The simpler approach: add floor index to Position component or a new Floor component.
Systems that process Position (movement, combat, AI, rendering) check that the entity's
floor matches the current floor.

### 5. Fog of War Per Floor
Each floor has its own explored state (already per-GameMap via `GameMap.explored`).
Visible tiles are recalculated when changing floors. Previously explored tiles on a
floor remain explored when returning.

### 6. Stair Placement
During dungeon zone generation:
- Place stairs down in the last room of each floor (farthest from entry/stairs up)
- Place stairs up in the first room of the next floor
- Stairs should be in walkable positions, not blocking doorways

### 7. Floor Generation
Each floor of a dungeon zone is generated independently using the same room generator
but with floor-specific parameters:
- Floor 0: more rooms, larger (entrance floor)
- Deeper floors: fewer rooms, tighter, higher intensity

## Open Questions
- Should overworld zones ever have multiple floors? Probably not — keep them single.
- How to handle AI entities when the player leaves a floor? Freeze their state, or
  let them continue acting? Freeze is simpler and expected in roguelikes.
- Should the minimap (future) show the current floor only?

## Tests
- Unit test: stairs down on floor N connect to stairs up on floor N+1
- Unit test: floor transition preserves player position correctly
- Manual: walking onto stairs and pressing Enter changes floor
- Manual: enemies on floor 0 don't chase player on floor 1
- Manual: fog of war is independent per floor
- Manual: returning to a previous floor shows explored tiles

## Definition of Done
- Stair tiles exist and render distinctly
- Dungeon zones can have 1-3 floors connected by stairs
- Player can traverse stairs with Enter
- Entities are scoped to floors (only active floor's entities process)
- Fog of war is per-floor
- `bun test` passes
