{
  "id": "57264ddf",
  "title": "Phase 2.3: Player awareness + relaxed idle turn economy",
  "tags": [
    "phase-2",
    "gameplay",
    "turns",
    "awareness"
  ],
  "status": "done",
  "created_at": "2026-02-15T04:37:39.816Z"
}

## Goal
Add the Awareness component to the player entity (same as enemies — universal entity
system). When no visible enemy is alert, the player is "idle" and the turn economy
resets after every action, allowing seamless exploration. When any visible enemy is
alert, the player becomes "alerted" and normal turn economy applies.

## Read First
- `AGENTS.md` — universal entity system constraint
- `docs/combat.md` — turn structure, action economy
- `docs/senses.md` — awareness states, sensory system

## Existing Code Context

### Awareness Component (`src/ecs/components.ts`)
Already exists for enemies:
```typescript
Awareness: {
  state: "idle" | "alert";
  lastKnownTarget: { x: number; y: number } | null;
  alertDuration: number;
  turnsWithoutTarget: number;
}
```

Player entities currently don't have this component.

### SensorySystem (`src/ecs/systems/sensory.ts`)
Runs LOS raycasting for all entities with Senses + Position. Updates fog of war for
player. Updates Awareness on AI entities (idle → alert when they see a hostile).

Currently only processes AI entities for awareness transitions. Needs to also evaluate
the player's awareness.

### TurnActor Component (`src/ecs/components.ts`)
```typescript
TurnActor: {
  hasActed: boolean;
  movementRemaining: number;
  secondaryUsed: boolean;
}
```

### Turn System (`src/ecs/systems/turn.ts`)
Resets `TurnActor` at the start of each entity's turn. Checks if turn is complete
(hasActed or movementRemaining === 0 and other conditions).

### Player Entity (`src/index.ts`)
Player has: Position, Renderable, PlayerControlled, Collidable, Health, Stats,
TurnActor, Faction, Inventory, Equipment, Senses.
Does NOT have: Awareness, AIControlled.

## Requirements

### 1. Add Awareness to Player
In `src/index.ts`, add Awareness component to the player entity:
```typescript
world.addComponent(player, "Awareness", {
  state: "idle",
  lastKnownTarget: null,
  alertDuration: 0,
  turnsWithoutTarget: 0,
});
```

The `alertDuration` and `turnsWithoutTarget` fields aren't meaningful for the player
(the player's state is purely derived from visible enemies), but keeping the same
component shape satisfies the universal entity constraint. They can be ignored.

### 2. Update SensorySystem for Player Awareness
In `src/ecs/systems/sensory.ts`, after computing visible tiles for the player, evaluate
player awareness:

```typescript
// After LOS calculation for player
const playerAwareness = world.getComponent(playerEntity, "Awareness");
if (playerAwareness) {
  const anyAlertEnemy = visibleEntities.some(e => {
    const ai = world.getComponent(e, "AIControlled");
    const awareness = world.getComponent(e, "Awareness");
    const faction = world.getComponent(e, "Faction");
    return ai && awareness?.state === "alert" && faction?.factionId !== "player";
  });
  playerAwareness.state = anyAlertEnemy ? "alert" : "idle";
}
```

The player is alerted if and only if they can see at least one alert hostile entity.

### 3. Idle Turn Economy Reset
After each player action (movement, primary, or secondary), if the player's awareness
is "idle", reset the turn economy:

In the turn processing or game loop (wherever player actions are resolved):
```typescript
const awareness = world.getComponent(player, "Awareness");
if (awareness?.state === "idle") {
  const turn = world.getComponent(player, "TurnActor");
  if (turn) {
    turn.hasActed = false;
    turn.movementRemaining = world.getComponent(player, "Stats")!.speed;
    turn.secondaryUsed = false;
  }
}
```

This goes after the action is processed but before checking if the turn is complete.

### 4. Turn Completion in Idle
When idle, the player's turn should never auto-complete from running out of actions
(since they always reset). The turn only advances when:
- The player presses `.` (hold/pass) — explicitly ends the turn
- The player transitions to alerted mid-action (stop resetting, turn economy takes over)

When alerted, normal turn completion rules apply (primary action ends turn, or
movement exhausted + no remaining actions).

### 5. Enemy Turns During Idle
When the player is idle, enemies still get their turns. Since all enemies are idle too
(if any were alert, the player would be alerted), they just do nothing on their turns.
The turn system processes them normally — their idle behavior is to stand still.

This means pressing an arrow key while idle: player moves → turn resets → enemies take
turns (do nothing) → player's turn again → seamless exploration.

### 6. Transition: Idle → Alerted
When the SensorySystem flips the player from idle to alerted (because an enemy just
became alert after seeing the player):

1. The reset already happened for the current action (since player was idle when it started)
2. The player has a full turn of actions
3. Normal turn economy applies from this point

No special transition code needed — stopping the reset IS the transition.

### 7. Transition: Alerted → Idle
When the last alert enemy dies or leaves vision:
1. SensorySystem sets player to idle
2. Next action resets turn economy
3. Exploration mode resumes

### 8. UI Indicator
Show the player's awareness state in the PlayerStats panel (from TODO-9297365f):
- Idle: no indicator, or subtle `[Exploring]` in gray
- Alerted: `[ALERT!]` in brightRed or yellow

This gives the player clear feedback about which mode they're in.

## Edge Cases
- **Player walks into room with idle enemy**: player moves (idle, resets) → sensory
  runs → enemy sees player → enemy goes alert → sensory checks player → player sees
  alert enemy → player goes alerted → next action uses normal economy with full turn.
- **Player kills last enemy**: combat action resolves → enemy dies → sensory runs →
  no alert enemies visible → player goes idle → next action resets.
- **Enemy visible but not alert** (player sees them from afar): player stays idle.
  This is intentional — allows tactical positioning before engaging.
- **Player presses `.` while idle**: turn passes, enemies take turns (do nothing),
  new turn starts. Harmless.

## Tests
- Unit test: player with no visible alert enemies has awareness "idle"
- Unit test: player with a visible alert enemy has awareness "alerted"
- Unit test: turn economy resets after action when player is idle
- Unit test: turn economy does NOT reset after action when player is alerted
- Unit test: killing the last alert enemy transitions player back to idle
- Manual: player can move freely without pressing `.` when no enemies visible
- Manual: entering combat snaps to normal turn economy with full actions
- Manual: leaving combat returns to seamless movement
- Manual: UI shows alert state transition

## Definition of Done
- Player entity has Awareness component
- SensorySystem sets player awareness based on visible alert enemies
- Turn economy resets after each action when idle
- Normal turn economy when alerted (no reset)
- Player always has full actions when transitioning to alerted
- UI indicates current awareness state
- Seamless exploration feel when no threats present
- `bun test` passes
