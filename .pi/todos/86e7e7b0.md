{
  "id": "86e7e7b0",
  "title": "Balancing pass — tune combat, items, enemy scaling, and economy",
  "tags": [
    "gameplay",
    "balance",
    "combat",
    "items"
  ],
  "status": "done",
  "created_at": "2026-02-15T23:36:21.552Z"
}

## Goal
Comprehensive tuning pass once TODO-a4b2f334 (AI potion use) is complete.
All combat mechanics are in place at that point — this pass ensures they
feel good together before building zones/floors on top.

## Current Values (verified from code)

### Player (`room-populator.ts` createPlayer)
- HP: 20/20
- Strength: 5, Defense: 2, Speed: 3
- Carry capacity: 30
- Vision range: 8

### Enemies

**Goblin** (`room-populator.ts` createGoblin) — charger
- Base: 8 HP, 3 str, 1 def, speed 2, vision 6, alertDuration 5
- Scaling: `(base + difficulty * multiplier) * (1 + intensity * 0.5)`
- HP scale: difficulty * 1.5, str scale: difficulty * 0.5, def scale: difficulty * 0.3
- Weapon: Iron Sword (5 dmg, range 1, melee)
- Potion: 30% chance

**Rotwood Archer** (`enemy-factory.ts`) — archer
- Base: 6 HP, 2 str, 1 def, speed 2, vision 7, alertDuration 4
- Weapon: Short Bow (3 dmg, range 6, ranged)
- Potion: 25% chance

**Thornback Guardian** (`enemy-factory.ts`) — guardian
- Base: 15 HP, 4 str, 4 def, speed 1, vision 5, alertDuration 3
- Weapon: Iron Spear (4 dmg, range 2, reach), Chainmail (4 def, -1 speed)
- Potion: 100%, canDrinkPotions: true

**Blightvines Skulker** (`enemy-factory.ts`) — skulker
- Base: 7 HP, 4 str, 1 def, speed 3, vision 6, alertDuration 6
- Weapon: Iron Sword (5 dmg, range 1, melee)
- Potion: 25% chance

**Hollow Patrol** (`enemy-factory.ts`) — patrol
- Base: 10 HP, 3 str, 2 def, speed 2, vision 6, alertDuration 5
- Weapon: Sword & Shield (4 dmg, range 1, melee, +2 def)
- Potion: 30% chance

**Boss** (`room-populator.ts` createBoss) — charger
- Base: 20 HP, 5 str, 3 def, speed 2, vision 8, alertDuration 8
- HP scale: difficulty * 3, str scale: difficulty * 1, def scale: difficulty * 0.5
- Weapon: Battle Axe (7 dmg, range 1, melee)
- Potion: 100%, canDrinkPotions: true

### Weapons (item-factory.ts)
| Weapon | Dmg | Range | Type | DefBonus | Weight |
|--------|-----|-------|------|----------|--------|
| Iron Sword | 5 | 1 | melee | 0 | 6 |
| Sword & Shield | 4 | 1 | melee | 2 | 7 |
| Battle Axe | 7 | 1 | melee | 0 | 8 |
| Mace & Shield | 4 | 1 | melee | 2 | 6 |
| Iron Spear | 4 | 2 | reach | 0 | 5 |
| Halberd | 6 | 2 | reach | 0 | 9 |
| Short Bow | 3 | 6 | ranged | 0 | 4 |
| Crossbow | 5 | 8 | ranged | 0 | 6 |
| Oak Staff | 4 | 4 | ranged | 0 | 3 |
| Wand | 3 | 3 | ranged | 0 | 2 |

### Armor
| Armor | Def | Speed Penalty | Weight |
|-------|-----|---------------|--------|
| Leather Armor | 2 | 0 | 5 |
| Chainmail | 4 | -1 | 10 |
| Plate Armor | 6 | -2 | 15 |

### Accessories (all +1 to one stat, weight 1-2)
- Iron Ring: +1 str
- Ward Amulet: +1 def
- Swift Boots: +1 speed

### Consumables
| Potion | Effect | Power | Duration | Charges |
|--------|--------|-------|----------|---------|
| Healing | heal | 8 | 0 | 3 |
| Speed | +speed | 1 | 5 turns | 2 |
| Strength | +str | 2 | 5 turns | 2 |
| Defense | +def | 2 | 5 turns | 2 |

### Combat Formula (`combat.ts` performAttackDamage)
```
variance = floor(rng * 3) - 1   // -1, 0, or +1
damage = max(1, weaponDamage - totalDefense + variance)
if rng < 0.05: damage *= 2      // 5% crit, 2x multiplier
```
Note: strength is NOT added to weapon damage. `baseDamage = weapon ? weapon.damage : attackerStats.strength`. Unarmed uses strength, armed uses weapon damage only.

### Defend Mechanic (`stats.ts`, `combat.ts`)
- +2 defense bonus while Defending
- Counterattack on melee hit (dist ≤ 1), then Defending removed

### Encumbrance (`turn.ts` getEncumbrancePenalty)
- >100% capacity: can't pick up
- >75%: -2 speed
- >50%: -1 speed
- ≤50%: no penalty

### Difficulty
- Currently hardcoded `{ difficulty: 1 }` in `src/index.ts`
- Enemy stats scale: `(base + difficulty * multiplier) * intensityScale`

### Dungeon Structure (dungeon-generator.ts)
- 10 rooms, intensity 0.0-1.0
- Combat rooms: 1-3 enemies depending on intensity
- Loot rooms: 2-5 items, 30% guardian
- Boss room: 1 boss + 1-2 items
- Entry: 1-2 items (starter)
- Floor item spawns from ITEM_POOL (weighted random)

### Floor Item Pool Weights (room-populator.ts)
- Each weapon: weight 2 (10 weapons = 20 total)
- Each armor: weight 3 (3 armors = 9 total)
- Each accessory: weight 2 (3 accessories = 6 total)
- Healing Potion: weight 5
- Other potions: weight 2 each (3 = 6 total)
- Total pool weight: 46
- Healing Potion chance: 5/46 ≈ 11% per floor item

### Drop Rates (health.ts shouldDrop)
- Consumables: always drop (100%)
- Equipped weapon: always drop (100%)
- Equipped armor: 75%
- Equipped accessories: 50%
- Other inventory items: 50%

## Areas to Evaluate

### 1. Damage Formula
- Strength has NO effect on weapon damage — only matters unarmed. Is this intentional?
  Armed player with 5 str and Iron Sword (5 dmg) deals same as 1 str player.
  Strength buffs/potions/accessories do nothing for armed attacks.
- This makes Iron Ring (+1 str) useless once armed.
- Variance of ±1 is very narrow — fights feel samey.
- Options: add fraction of str to weapon dmg, or keep weapons as the sole scaling stat.

### 2. Player Survivability
- Player has 20 HP. Healing Potion heals 8 (40% of max) with 3 charges.
- Goblin with Iron Sword (5 dmg) vs player 2 def: `max(1, 5-2+var)` = 2-4 dmg per hit.
  Player dies in 5-10 goblin hits. Seems reasonable.
- Boss with Battle Axe (7 dmg) vs player 2 def: 4-6 per hit. Dead in 3-5 hits.
  With Chainmail (+4 def): 1-2 per hit. Very tanky vs boss but speed 1.
- Guardian with Spear (4 dmg) vs player 2 def: 1-3 per hit. Very slow attrition.

### 3. Potion Economy
- Healing Potion: 8 HP × 3 charges = 24 total healing (more than full HP pool).
- Floor spawn: ~11% per item spawn. With ~5-10 floor items per run, expect ~1 from floor.
- Enemy drops: goblins 30%, others 25-30%, guardian/boss 100%.
  With ~10-15 enemies per run, expect 3-5 potions from drops.
- Total expected healing potions: ~4-6 per run. That's 72-144 HP of healing
  against a 20 HP pool. Might be too generous?

### 4. Weapon Balance
- Battle Axe (7 dmg, weight 8) vs Iron Sword (5 dmg, weight 6): axe is +40% dmg
  for +2 weight. Axe dominates melee.
- Shield weapons (4 dmg, +2 def): -20% to -43% damage for +2 def. Steep cost.
  With Chainmail the def is already high — shield might be overkill.
- Short Bow (3 dmg, range 6): very low damage for range advantage. 
  Against 2 def: 1-2 dmg. Takes 10-20 hits to kill a goblin at range.
- Crossbow (5 dmg, range 8): best ranged option but still worse than melee axe.
- Ranged vs melee tradeoff seems too steep.

### 5. Armor Tradeoffs
- Plate Armor (6 def, -2 speed, weight 15): speed 3→1, one move per turn.
  With player carry capacity 30, plate alone is 50% of capacity.
  Combined with Battle Axe (8): 23/30 = 77%, triggering -2 encumbrance.
  Total speed: 3 - 2(plate) - 2(encumbrance) = -1, clamped to 0. Can't move at all!
- Chainmail (4 def, -1 speed, weight 10): speed 3→2, two moves. More viable.
- Leather (2 def, 0 speed, weight 5): no tradeoff, but only +2 def total (with
  base 2 def, total 4). Marginal against 5+ dmg enemies.

### 6. Accessory Impact
- All accessories give +1 to a single stat. Very marginal.
- +1 strength does nothing while armed (see damage formula issue).
- +1 defense = 1 less damage per hit. Noticeable but small.
- +1 speed = 1 more move per turn. Most impactful of the three.

### 7. Enemy Scaling
- At difficulty 1, intensity 0.5: goblin has `(8 + 1.5) * 1.25` = 11 HP,
  `(3 + 0.5) * 1.25` = 4 str, `(1 + 0.3) * 1.25` = 1 def.
- Intensity range 0.0-1.0 gives 1.0x-1.5x scaling. Fairly mild.
- Difficulty is fixed at 1 with no mechanism to increase it.

### 8. AI Potion Drinking Threshold
- 40% HP threshold. Guardian with 15 base HP drinks at 6 HP.
- One drink per alert phase. Heals 8 HP. Guardian goes from 6 to 14.
- This significantly extends guardian fights. May feel tedious if damage
  output is low (e.g., player has Short Bow doing 1-2 dmg).

## Approach
This is a play-test-and-adjust pass, not a redesign. Specific changes TBD
after running the game and feeling the numbers. The data above establishes
the baseline for comparison.

Key questions to answer through play:
1. Is strength being ignored for armed attacks a bug or design choice?
2. Are healing potions too abundant?
3. Is ranged damage viable or does everything funnel to Battle Axe?
4. Does Plate Armor actually work given weight/speed math?
5. Do accessories feel worth equipping?
6. Does the guardian potion-drink extend fights too much?

## Files Likely to Change
- `src/ecs/systems/combat.ts` — damage formula (strength scaling?)
- `src/items/item-factory.ts` — weapon damage, potion values, accessory bonuses
- `src/enemies/enemy-factory.ts` — enemy base stats
- `src/map/room-populator.ts` — player stats, boss stats, goblin stats, item pool weights
- `src/ecs/systems/turn.ts` — encumbrance thresholds
- `src/ecs/systems/stats.ts` — defend bonus value

## Depends On
- TODO-a4b2f334 (AI potion use) — all combat mechanics must be in place first

## Definition of Done
- All values playtested and adjusted
- No obvious dominant strategies (one weapon/armor always best)
- Player can survive a full dungeon with smart play
- Fights feel tense but not tedious
- Ranged weapons have a viable niche
- Armor choices involve real tradeoffs
- Accessories feel worth picking up
- `bun test` passes after all adjustments
