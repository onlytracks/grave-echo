{
  "id": "22b0c5f3",
  "title": "Phase 0a.4: Input System + Movement System",
  "tags": [
    "phase-0a",
    "systems",
    "input"
  ],
  "status": "done",
  "created_at": "2026-02-14T22:59:03.941Z"
}

## Goal
Handle keyboard input and translate arrow keys into player movement on the grid.

## Read First
- `AGENTS.md` — project constraints (universal entity system)
- `docs/combat.md` — turn structure, movement rules
- `docs/technical.md` — input handling, key bindings, input state machine

## Dependencies
- Requires: Phase 0a.1 (ECS Core), Phase 0a.3 (Game Map)

## Requirements

### `src/input/input-handler.ts` — Raw Input Capture
- Enable raw mode on stdin to capture individual keypresses
- Parse raw bytes into a typed `InputEvent`:
  ```typescript
  type InputEvent =
    | { type: 'move'; direction: 'up' | 'down' | 'left' | 'right' }
    | { type: 'quit' }
    | { type: 'unknown' }
  ```
- Arrow keys: up=`\x1b[A`, down=`\x1b[B`, right=`\x1b[C`, left=`\x1b[D`
- `q` or `Escape` = quit
- For Phase 0a, only these inputs matter. More will be added later.
- Must handle graceful cleanup (disable raw mode on exit/crash)

### `src/ecs/systems/input.ts` — Input System
- Finds the entity with `PlayerControlled` + `Position` components
- Given an `InputEvent` of type 'move', calculates the target position
- Does NOT move the entity — passes the intent to the MovementSystem
- This system is specific to player input but the movement it triggers uses the
  universal MovementSystem

### `src/ecs/systems/movement.ts` — Movement System
- **Universal** — works for ANY entity with a Position component, not just the player
- Takes an entity ID and a target position
- Checks the GameMap: is the target tile walkable?
- Checks for entity collision: is another entity with Collidable + Position at the target?
- If valid, updates the entity's Position component
- If invalid (wall or blocked), movement fails silently (no position change)

### Important: Movement System is NOT player-specific
The MovementSystem takes any entity ID. The InputSystem calls it for the player.
In Phase 0b, the AISystem will call the same MovementSystem for enemies. This is
the universal entity principle in action — same movement logic for all entities.

## Tests

### `src/ecs/systems/__tests__/movement.test.ts`
- Entity moves to valid floor tile — position updates
- Entity cannot move into wall — position unchanged
- Entity cannot move out of bounds — position unchanged
- Entity cannot move into another Collidable entity — position unchanged
- Entity can move into tile with non-Collidable entity (items on floor)

### `src/input/__tests__/input-handler.test.ts`
- Arrow key bytes parse to correct move directions
- Escape parses to quit
- Unknown bytes parse to unknown

## Definition of Done
- Arrow keys move the player around the hardcoded room
- Player cannot walk through walls or off the map
- Movement logic is entity-agnostic (any entity can be moved)
- `bun test` passes all tests
