{
  "id": "9297365f",
  "title": "Phase 2.1: UI Panels (PlayerStats, TargetInfo, MessageLog, Equipment) + Debug Panel Rework",
  "tags": [
    "phase-2",
    "renderer",
    "panels",
    "ui"
  ],
  "status": "done",
  "created_at": "2026-02-15T03:10:15.216Z"
}

## Goal
Replace the ad-hoc status bar and message lines with proper UI panels: PlayerStats,
TargetInfo, EquipmentPanel, and MessageLog. Rework the debug panel so it replaces the
MessageLog when toggled on, showing messages plus ECS internals. Implement a layout
manager that assigns screen regions to panels.

## Read First
- `AGENTS.md` — project constraints (renderer abstraction)
- `docs/technical.md` — Screen Components table, Screen Layout diagram, Renderer interface

## Existing Code Context

### Current Rendering (`src/game.ts`)
`Game.render()` currently does an ad-hoc layout:
- Game grid takes 60% width left, debug panel takes 40% right (always visible)
- Status bar below grid: HP, moves, weapon, keybinds — one line
- Legend line below that: character meanings
- 3-line message log below that (from `MessageLog.getMessages()`)

This will be replaced entirely with a proper panel layout.

### Panels That Exist
- `src/renderer/panels/game-grid.ts` — `renderGameGrid(renderer, world, map, region, viewport, visibleTiles)`
- `src/renderer/panels/debug-panel.ts` — `renderDebugPanel(renderer, world, region)` — shows
  entity count, player details, AI entity details, inventory, items at feet

### Renderer Interface (`src/renderer/renderer.ts`)
```typescript
interface Renderer {
  init(): void; shutdown(): void; clear(): void;
  drawCell(x, y, char, fg, bg): void;
  drawText(x, y, text, fg): void;
  drawBox(x, y, width, height, title?): void;
  flush(): void;
  getScreenSize(): { width, height };
}
```
All panels must use this interface only — no direct ANSI.

### MessageLog (`src/ecs/systems/messages.ts`)
```typescript
class MessageLog {
  add(message: string): void
  getMessages(): readonly string[]
  clear(): void
}
```
Currently capped at 3 messages. Needs to store more for the panel.

### Input (`src/input/input-handler.ts`)
F1 toggle for debug is NOT yet implemented in the input handler. The current debug panel
is always visible. Need to add F1 input event and toggle behavior.

### Components Available
- `Health: { current, max }`
- `Stats: { strength, defense, speed }`
- `Equipment: { weapon: entityId | null }`
- `Inventory: { items: entityId[], totalWeight, carryCapacity }`
- `TurnActor: { hasActed, movementRemaining, secondaryUsed }`
- `Weapon: { damage, range, weaponType }`
- `Item: { name, weight, rarity }`
- `Consumable: { effectType, power, charges, maxCharges }`
- `Faction: { factionId }`
- `Senses: { vision: { range } }`
- `Awareness: { state, lastKnownTarget, alertDuration, turnsWithoutTarget }`

## Requirements

### 1. Layout Manager (`src/renderer/layout.ts`)

Calculates panel regions from terminal size. Returns a struct of regions:

```typescript
interface LayoutRegions {
  gameGrid: { x: number; y: number; width: number; height: number };
  playerStats: { x: number; y: number; width: number; height: number };
  targetInfo: { x: number; y: number; width: number; height: number };
  messageLog: { x: number; y: number; width: number; height: number };
  equipment: { x: number; y: number; width: number; height: number };
}

export function calculateLayout(screenWidth: number, screenHeight: number): LayoutRegions
```

Target layout:
```
┌──────────────────────────┬───────────────┐
│                          │ PlayerStats   │
│       GameGrid           ├───────────────┤
│                          │ TargetInfo    │
├──────────────────────────┼───────────────┤
│ MessageLog / Debug       │ EquipmentPanel│
└──────────────────────────┴───────────────┘
```

Proportions:
- Left column: ~70% of screen width
- Right column: ~30% of screen width
- Top row: ~70% of screen height
- Bottom row: ~30% of screen height
- PlayerStats: top-right, upper half of right column
- TargetInfo: top-right, lower half of right column
- Equipment: bottom-right
- MessageLog: bottom-left (same region used by debug panel when toggled)

Minimum sizes: right column at least 20 chars wide, bottom row at least 6 rows tall.

### 2. `src/renderer/panels/player-stats.ts` — PlayerStats Panel

```typescript
export function renderPlayerStats(
  renderer: Renderer, world: World,
  region: { x: number; y: number; width: number; height: number },
): void
```

Display:
- Box with title "Player"
- HP bar: `HP: 15/20 [███████░░░]` — filled portion colored green (>50%), yellow (25-50%), red (<25%)
- Stats: `STR: 5  DEF: 2  SPD: 3`
- Weapon: `Wpn: Iron Sword (5 dmg)` or `Wpn: Fists`
- Moves: `Moves: 2/3`
- Weight: `Weight: 10/30 (33%)`

Read from the player entity (query `PlayerControlled`).

### 3. `src/renderer/panels/target-info.ts` — TargetInfo Panel

```typescript
export function renderTargetInfo(
  renderer: Renderer, world: World,
  region: { x: number; y: number; width: number; height: number },
  targetEntity: number | null,
): void
```

If `targetEntity` is null or invalid, show an empty box with title "Target" and text
"No target selected" in gray.

When a target is selected (future — tab targeting):
- Box with title "Target"
- Name/char: `Goblin (g)`
- HP bar (same style as player)
- Stats: STR, DEF, SPD
- Weapon if equipped
- Distance from player (manhattan)
- Awareness state if AI entity

For now, always pass `null` — the panel just shows "No target selected".

### 4. `src/renderer/panels/message-log.ts` — MessageLog Panel

```typescript
export function renderMessageLog(
  renderer: Renderer,
  region: { x: number; y: number; width: number; height: number },
  messages: readonly string[],
): void
```

- Box with title "Log"
- Show the most recent N messages that fit in the panel height (region.height - 2 lines)
- Most recent message at the bottom
- Older messages above, scrolling up
- Color: most recent message in white, older messages fade to gray

### 5. Update MessageLog Class

In `src/ecs/systems/messages.ts`:
- Increase `maxMessages` default from 3 to 50 (or remove the cap)
- Add a method to get the last N messages:
  ```typescript
  getRecent(count: number): readonly string[]
  ```

### 6. Update Debug Panel

Rework `src/renderer/panels/debug-panel.ts` to serve as MessageLog replacement:

When debug mode is on, it renders in the **messageLog region** (bottom-left) instead
of the right side. It should show:

- **Messages section** — same messages as MessageLog, but with more detail. Show all
  recent messages plus turn markers: `--- Turn 5 ---` between turns so you can see
  what happened when. Add a turn counter to MessageLog or Game to track this.
- **World state section** — entity count, player turn state (acted/moves/secondary)
- **AI section** — for each AI entity: awareness state, distance to player, last action

Keep the existing data but reorganize to fit in the bottom-left region (wider, shorter)
instead of the right column (narrower, taller).

The debug panel should share the same region as the message log — when debug is on,
message log is hidden and debug takes its place.

### 7. F1 Toggle

In `src/input/input-handler.ts`:
- Add `{ type: 'toggleDebug' }` to `InputEvent` union
- Parse F1 key: escape sequence `\x1b[11~` (most terminals) or `\x1bOP` (xterm)

In `src/game.ts`:
- Add `debugVisible: boolean = false` field
- Handle `toggleDebug` event: flip `debugVisible`, does NOT consume a turn action
- In `render()`: if `debugVisible`, call `renderDebugPanel()` for the messageLog region;
  otherwise call `renderMessageLog()`

### 8. Rewrite `Game.render()`

Replace the entire render method to use the layout manager:

```typescript
private render(): void {
  this.renderer.clear();
  const size = this.renderer.getScreenSize();
  const layout = calculateLayout(size.width, size.height);

  const viewport = this.calculateViewport(
    layout.gameGrid.width - 2, layout.gameGrid.height - 2
  );
  renderGameGrid(this.renderer, this.world, this.map,
    layout.gameGrid, viewport, this.visibleTiles);

  renderPlayerStats(this.renderer, this.world, layout.playerStats);
  renderTargetInfo(this.renderer, this.world, layout.targetInfo, null);
  renderEquipment(this.renderer, this.world, layout.equipment);

  if (this.debugVisible) {
    renderDebugPanel(this.renderer, this.world, layout.messageLog);
  } else {
    renderMessageLog(this.renderer, layout.messageLog, this.messages.getRecent(layout.messageLog.height - 2));
  }

  this.renderer.flush();
}
```

Remove: status bar line, legend line, old ad-hoc layout math.

### 9. `src/renderer/panels/equipment.ts` — EquipmentPanel

```typescript
export function renderEquipment(
  renderer: Renderer, world: World,
  region: { x: number; y: number; width: number; height: number },
): void
```

Display:
- Box with title "Equipment"
- `Weapon: Iron Sword` or `Weapon: ---`
- `Armor:  ---` (placeholder, not implemented yet)
- `Acc 1:  ---` (placeholder)
- `Acc 2:  ---` (placeholder)
- Blank line
- `Inventory (3 items):` header
- List each item: `  Iron Sword (6 wt)` — highlight equipped items in a different color
- Show consumable charges: `  Healing Potion (2/3)`

### 10. Turn Counter for Debug

Add a turn counter to the `Game` class. Increment it each time a new player turn starts.
Pass it to the debug panel so it can insert turn markers in the message stream.

Update MessageLog to optionally tag messages with the turn number:
```typescript
add(message: string, turn?: number): void
getMessagesWithTurns(): readonly { text: string; turn: number }[]
```

The message log panel ignores turn numbers (just shows text). The debug panel uses them
to insert `--- Turn N ---` separators.

## Tests
No automated tests for panel rendering — these are visual. Verify manually:
- All 4 panels render in correct positions with box borders and titles
- PlayerStats shows accurate live data (HP changes after combat, moves decrement)
- Equipment panel shows inventory and equipped weapon
- MessageLog shows scrolling messages, most recent at bottom
- F1 toggles between MessageLog and Debug panel in the same region
- Debug panel shows messages with turn separators plus AI awareness state
- Terminal resize doesn't crash (layout recalculates)
- Panels don't overflow their regions (text is truncated to fit)

## Definition of Done
- 4-panel layout renders: PlayerStats (top-right), TargetInfo (top-right below stats),
  MessageLog (bottom-left), EquipmentPanel (bottom-right)
- Game grid fills top-left
- F1 toggles debug panel in place of message log
- Debug panel shows messages with turn markers plus world state
- TargetInfo shows "No target selected" (tab targeting is future work)
- No more ad-hoc status bar or legend line
- `bun test` still passes (no regressions)

## Terminology Note
Use "glyph" instead of "character" when referring to Unicode symbols used for rendering
tiles and entities. See `AGENTS.md` terminology table.
