{
  "id": "2176868f",
  "title": "Phase 1.2: Basic Dungeon Generation (5 Connected Rooms)",
  "tags": [
    "phase-1",
    "worldgen",
    "map"
  ],
  "status": "done",
  "created_at": "2026-02-15T01:28:18.378Z"
}

## Goal
Replace the hardcoded test room with a simple procedural dungeon generator that creates
5 connected rooms with corridors. Spawn multiple enemies across rooms.

## Read First
- `AGENTS.md` — project constraints
- `docs/world.md` — world structure, pacing (not all applicable yet, but gives context)
- `docs/combat.md` — enemy types and AI patterns (Charger is the only one implemented)

## Existing Code Context
- Map: `src/map/game-map.ts` — `GameMap` class with `setTile()`, `isWalkable()`, `isInBounds()`.
  Tiles are `FLOOR_TILE` and `WALL_TILE` constants.
- Current room: `src/map/room-builder.ts` — `buildTestRoom()` returns a 20x15 hardcoded map.
  This will be replaced.
- Entry point: `src/index.ts` — creates the World, map, player, one goblin, and starts the game.
  Player is placed at (10, 7), goblin at (3, 3).
- Game: `src/game.ts` — `Game` class takes World, GameMap, Renderer. The game grid renders
  based on map dimensions and a viewport.
- Renderer: `src/renderer/panels/game-grid.ts` — renders map tiles then entities. Uses a
  viewport offset. Already supports maps larger than the screen via viewport.

## Requirements

### `src/map/dungeon-generator.ts` — Dungeon Generator

Generate a dungeon with the following algorithm:
1. Start with a fully walled map (all WALL_TILE), size ~60x40
2. Place 5 rooms at random non-overlapping positions
   - Room sizes: random between 5x5 and 10x8
   - Rooms must not overlap (leave at least 1 tile gap between rooms)
   - Rooms are carved out as FLOOR_TILE with WALL_TILE borders
3. Connect rooms with corridors
   - Use L-shaped corridors (horizontal then vertical, or vice versa)
   - Connect each room to the next (room 1→2, 2→3, etc.) to guarantee connectivity
   - Corridors are 1 tile wide, carved as FLOOR_TILE
4. Return the generated map plus a list of room center positions (for spawning)

```typescript
interface DungeonResult {
  map: GameMap;
  rooms: { x: number; y: number; width: number; height: number }[];
}

export function generateDungeon(rng?: () => number): DungeonResult
```

Accept an optional RNG function for deterministic testing (default to Math.random).

### Update `src/index.ts` — Use Generated Dungeon
- Replace `buildTestRoom()` with `generateDungeon()`
- Place the player at the center of the first room
- Spawn 1 goblin enemy in each of rooms 2-5 (4 total enemies), at room centers
- Each goblin gets the same components as the current one (charger AI targeting player)
- The viewport in game-grid.ts already supports offsets — the game needs to track the
  viewport and center it on the player

### Viewport / Camera
The dungeon (60x40) is larger than the terminal. Implement camera following:
- In `src/game.ts`, calculate viewport so the player is centered on screen
- Update viewport after each player move
- Clamp viewport to map bounds (don't show beyond map edges)
- Pass the viewport to `renderGameGrid()` (it already accepts a Viewport parameter)

```typescript
function calculateViewport(
  playerX: number, playerY: number,
  mapWidth: number, mapHeight: number,
  viewWidth: number, viewHeight: number,
): Viewport {
  return {
    x: Math.max(0, Math.min(playerX - Math.floor(viewWidth / 2), mapWidth - viewWidth)),
    y: Math.max(0, Math.min(playerY - Math.floor(viewHeight / 2), mapHeight - viewHeight)),
  };
}
```

### Keep `room-builder.ts`
Don't delete it — it's useful for testing. Just stop using it in index.ts.

## Tests (`src/map/__tests__/dungeon-generator.test.ts`)
Use a seeded RNG for deterministic tests:
- Generated map has correct dimensions (60x40)
- All 5 rooms exist and have floor tiles
- Rooms don't overlap
- All rooms are connected (flood fill from room 1 center reaches all other room centers)
- Room centers are walkable
- Corridors are walkable (floor tiles connect rooms)
- Map border is all walls (nothing carved at edges)

## Design Constraints
- Keep generation simple — this is not the final world gen, just enough to test gameplay
  in a multi-room space
- The generator must be deterministic when given a seed (for testing)
- Don't add new components or systems — this only touches map generation and entity spawning

## Definition of Done
- `bun run start` launches a game with a procedurally generated 5-room dungeon
- Player starts in room 1, 4 goblins in rooms 2-5
- Camera follows the player through the dungeon
- Corridors connect all rooms — player can reach every room
- Each run produces a different layout (random generation)
- `bun test` passes dungeon generation tests
- The hardcoded room-builder.ts is preserved but unused
